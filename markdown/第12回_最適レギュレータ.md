# 第12回：最適レギュレータ

## 学習目標
- 最適制御問題の定式化を理解する
- 線形二次レギュレータ（LQR）の理論を学ぶ
- 重み行列の選択方法を習得する

## 1. はじめに

これまで、極配置法による制御器設計を学びました。しかし、どのような極を選ぶべきかは設計者の経験に依存していました。本講では、ある性能指標を最小化するという**最適制御**の枠組みを学びます。

## 2. 最適制御問題

### 2.1 問題設定

システム：
$$\dot{\mathbf{x}}(t) = \mathbf{A}\mathbf{x}(t) + \mathbf{B}\mathbf{u}(t), \quad \mathbf{x}(0) = \mathbf{x}_0$$

以下の**性能指標（評価関数、コスト関数）**を最小化する制御入力 $\mathbf{u}(t)$ を求めます：

$$J = \int_0^\infty \left[ \mathbf{x}^T(t)\mathbf{Q}\mathbf{x}(t) + \mathbf{u}^T(t)\mathbf{R}\mathbf{u}(t) \right] dt$$

ここで：
- $\mathbf{Q} \geq 0$：状態の重み行列（半正定値対称行列）
- $\mathbf{R} > 0$：制御入力の重み行列（正定値対称行列）

### 2.2 性能指標の意味

- **第1項** $\mathbf{x}^T\mathbf{Q}\mathbf{x}$：状態の偏差に対するペナルティ
  - 状態を原点に近づけることを評価
- **第2項** $\mathbf{u}^T\mathbf{R}\mathbf{u}$：制御入力の大きさに対するペナルティ
  - 制御エネルギーの消費を抑制

**トレードオフ：**
- $\mathbf{Q}$ を大きく → 状態を素早く原点に収束（応答速度重視）
- $\mathbf{R}$ を大きく → 制御入力を小さく（省エネ重視）

### 2.3 LQR問題

上記の問題を**線形二次レギュレータ（Linear Quadratic Regulator: LQR）問題**と呼びます。

**名称の由来：**
- **線形（Linear）**：システムが線形
- **二次（Quadratic）**：性能指標が状態と入力の二次形式
- **レギュレータ（Regulator）**：状態を原点に制御

## 3. 最適制御則

### 3.1 定理

**定理（LQRの解）：**

LQR問題の最適制御則は、以下の**状態フィードバック**形式で与えられます：

$$\mathbf{u}^*(t) = -\mathbf{K}\mathbf{x}(t)$$

ここで、最適ゲイン $\mathbf{K}$ は：

$$\mathbf{K} = \mathbf{R}^{-1}\mathbf{B}^T\mathbf{P}$$

$\mathbf{P}$ は以下の**代数的リッカチ方程式（Algebraic Riccati Equation: ARE）**の正定値対称解です：

$$\mathbf{A}^T\mathbf{P} + \mathbf{P}\mathbf{A} - \mathbf{P}\mathbf{B}\mathbf{R}^{-1}\mathbf{B}^T\mathbf{P} + \mathbf{Q} = \mathbf{0}$$

### 3.2 最適値

最適制御則を用いたときの性能指標の最小値は：

$$J^* = \mathbf{x}_0^T\mathbf{P}\mathbf{x}_0$$

### 3.3 閉ループシステム

最適制御を適用した閉ループシステム：

$$\dot{\mathbf{x}} = (\mathbf{A} - \mathbf{B}\mathbf{K})\mathbf{x}$$

このシステムは常に安定です（$(\mathbf{A}, \mathbf{B})$ が可制御、$(\mathbf{A}, \mathbf{Q}^{1/2})$ が可観測の場合）。

## 4. リッカチ方程式

### 4.1 導出の概略

変分法（calculus of variations）または動的計画法（dynamic programming）を用いて導出されます。

**ハミルトン-ヤコビ-ベルマン方程式**から導かれます。

### 4.2 代数的リッカチ方程式（ARE）

$$\mathbf{A}^T\mathbf{P} + \mathbf{P}\mathbf{A} - \mathbf{P}\mathbf{B}\mathbf{R}^{-1}\mathbf{B}^T\mathbf{P} + \mathbf{Q} = \mathbf{0}$$

**性質：**
- 非線形行列方程式（$\mathbf{P}$ の二次項を含む）
- 複数の解を持ちうる
- 制御に用いるのは**正定値対称解**（安定化解）

### 4.3 解法

**数値解法：**
1. **固有値問題への変換**：ハミルトン行列の固有値分解
2. **反復法**：ニュートン法などの反復アルゴリズム
3. **MATLAB/Python**：`lqr`, `scipy.linalg.solve_continuous_are` などの関数

## 5. 重み行列の選択

### 5.2 重み行列 $\mathbf{Q}$ の選択

**対角形式：**
$$\mathbf{Q} = \text{diag}(q_1, q_2, \ldots, q_n)$$

- $q_i$ が大きい → 状態 $x_i$ を重視（素早く減衰）
- $q_i = 0$ → 状態 $x_i$ を直接評価しない

**一般形：**
$$\mathbf{Q} = \mathbf{C}^T\mathbf{C}$$

これにより、出力 $\mathbf{y} = \mathbf{C}\mathbf{x}$ の偏差を評価できます。

### 5.2 重み行列 $\mathbf{R}$ の選択

**スカラー入力の場合：**
$$\mathbf{R} = r > 0$$

- $r$ が大きい → 制御入力を抑制
- $r$ が小さい → 積極的な制御（応答速度優先）

**多入力の場合：**
$$\mathbf{R} = \text{diag}(r_1, r_2, \ldots, r_m)$$

各入力のコストを個別に設定できます。

### 5.3 設計指針

**ステップ1：** まず $\mathbf{Q} = \mathbf{C}^T\mathbf{C}$、$\mathbf{R} = \rho\mathbf{I}$ として試行

**ステップ2：** パラメータ $\rho$ を調整
- $\rho$ を小さくすると、応答が速くなるが制御入力が大きくなる
- $\rho$ を大きくすると、制御入力が小さくなるが応答が遅くなる

**ステップ3：** 個別の状態や入力に対する重みを微調整

**Brysonの規則：**

状態と入力の最大許容値を $x_{i,\max}$、$u_{j,\max}$ とすると：

$$q_i = \frac{1}{x_{i,\max}^2}, \quad r_j = \frac{1}{u_{j,\max}^2}$$

## 6. LQRの特性

### 6.1 安定性

**定理：**

システム $(\mathbf{A}, \mathbf{B})$ が可制御で、$(\mathbf{A}, \mathbf{Q}^{1/2})$ が可観測ならば、LQR制御により閉ループシステムは漸近安定である。

### 6.2 ロバスト性

LQR制御は優れたロバスト性を持ちます：

**ゲイン余裕：** 無限大 ～ 1/2（-6 dB ～ ∞ dB）
**位相余裕：** ±60°

これは、モデル化誤差に対して強いことを意味します。

### 6.3 リターンレシオ

閉ループシステムの安定余裕は、以下の**リターンレシオ**の固有値で評価されます：

$$\mathbf{I} + \mathbf{G}(s)\mathbf{K}$$

LQRでは、すべての周波数でゲイン余裕・位相余裕が保証されます。

## 7. 具体例

### 7.1 例題：倒立振子

システム（線形化モデル）：
$$\mathbf{A} = \begin{bmatrix} 0 & 1 \\ 20 & 0 \end{bmatrix}, \quad \mathbf{B} = \begin{bmatrix} 0 \\ 1 \end{bmatrix}$$

重み行列：
$$\mathbf{Q} = \begin{bmatrix} 100 & 0 \\ 0 & 1 \end{bmatrix}, \quad \mathbf{R} = 1$$

**リッカチ方程式を解く：**

数値計算により：
$$\mathbf{P} = \begin{bmatrix} 10.42 & 0.32 \\ 0.32 & 0.53 \end{bmatrix}$$

**最適ゲイン：**
$$\mathbf{K} = \mathbf{R}^{-1}\mathbf{B}^T\mathbf{P} = \begin{bmatrix} 0.32 & 0.53 \end{bmatrix}$$

**閉ループの極：**
$$\lambda_{1,2} = -0.265 \pm j4.47$$

### 7.2 MATLAB/Pythonでの実装

**MATLAB:**
```matlab
A = [0 1; 20 0];
B = [0; 1];
Q = [100 0; 0 1];
R = 1;
[K, P, poles] = lqr(A, B, Q, R);
```

**Python (SciPy):**
```python
import numpy as np
from scipy.linalg import solve_continuous_are

A = np.array([[0, 1], [20, 0]])
B = np.array([[0], [1]])
Q = np.array([[100, 0], [0, 1]])
R = np.array([[1]])

P = solve_continuous_are(A, B, Q, R)
K = np.linalg.inv(R) @ B.T @ P
```

## 8. 有限時間LQR

### 8.1 問題設定

有限時間区間 $[0, T]$ での性能指標：

$$J = \int_0^T \left[ \mathbf{x}^T(t)\mathbf{Q}\mathbf{x}(t) + \mathbf{u}^T(t)\mathbf{R}\mathbf{u}(t) \right] dt + \mathbf{x}^T(T)\mathbf{S}\mathbf{x}(T)$$

最後の項は終端コストです。

### 8.2 時変リッカチ方程式

最適ゲインは時変：$\mathbf{K}(t) = \mathbf{R}^{-1}\mathbf{B}^T\mathbf{P}(t)$

$\mathbf{P}(t)$ は以下の**微分リッカチ方程式（Differential Riccati Equation: DRE）**を満たします：

$$-\dot{\mathbf{P}}(t) = \mathbf{A}^T\mathbf{P}(t) + \mathbf{P}(t)\mathbf{A} - \mathbf{P}(t)\mathbf{B}\mathbf{R}^{-1}\mathbf{B}^T\mathbf{P}(t) + \mathbf{Q}$$

終端条件：$\mathbf{P}(T) = \mathbf{S}$

**関係：**
$T \to \infty$ のとき、$\mathbf{P}(t)$ は定常値に収束し、代数的リッカチ方程式の解になります。

## 9. 演習問題

### 問題1
以下のシステムに対して、$\mathbf{Q} = \text{diag}(1, 1)$, $\mathbf{R} = 1$ として、LQR制御器を設計せよ：
$$\mathbf{A} = \begin{bmatrix} 0 & 1 \\ -1 & -2 \end{bmatrix}, \quad \mathbf{B} = \begin{bmatrix} 0 \\ 1 \end{bmatrix}$$

### 問題2
LQR制御が優れたゲイン余裕と位相余裕を持つ理由を、性能指標の構造から考察せよ。

### 問題3
重み行列 $\mathbf{Q}$ を10倍にしたとき、閉ループシステムの極がどのように変化するか予想し、数値計算で確認せよ。

## 10. まとめ

- LQRは、二次形式の性能指標を最小化する最適制御問題
- 最適制御則は状態フィードバック形式で、ゲインはリッカチ方程式の解から計算
- 重み行列 $\mathbf{Q}$, $\mathbf{R}$ により、制御性能をトレードオフ
- LQR制御は安定性とロバスト性に優れる
- 実用的な設計手法として広く利用される

## 次回予告

次回は、**リッカチ方程式と最適性**について、より詳細な理論と応用を学びます。

## 参考文献

1. Brian D.O. Anderson & John B. Moore, "Optimal Control: Linear Quadratic Methods"
2. 美多勉『非線形制御入門』昭晃堂
3. Gene F. Franklin et al., "Feedback Control of Dynamic Systems"
