# 第13回：リッカチ方程式と最適性

## 学習目標
- リッカチ方程式の数学的性質を深く理解する
- 最適性の証明と動的計画法を学ぶ
- ハミルトン行列と固有値問題の関係を把握する

## 1. はじめに

前回、LQR問題の解としてリッカチ方程式を学びました。本講では、リッカチ方程式のより深い数学的性質と、最適性の証明、効率的な解法について学びます。

## 2. 代数的リッカチ方程式（ARE）の復習

### 2.1 定義

$$\mathbf{A}^T\mathbf{P} + \mathbf{P}\mathbf{A} - \mathbf{P}\mathbf{B}\mathbf{R}^{-1}\mathbf{B}^T\mathbf{P} + \mathbf{Q} = \mathbf{0}$$

### 2.2 解の存在と一意性

**定理：**

システム $(\mathbf{A}, \mathbf{B})$ が可制御で、$(\mathbf{A}, \mathbf{Q}^{1/2})$ が可観測ならば、ARには一意な正定値対称解 $\mathbf{P} > 0$ が存在する。これを**安定化解**と呼ぶ。

**証明の概略：**
1. ハミルトン行列の固有値解析により、安定部分空間を特定
2. その部分空間に対応する解が正定値であることを示す

## 3. 最適性の証明

### 3.1 変分法によるアプローチ

性能指標：
$$J = \int_0^\infty \left[ \mathbf{x}^T\mathbf{Q}\mathbf{x} + \mathbf{u}^T\mathbf{R}\mathbf{u} \right] dt$$

**ラグランジアン：**
$$\mathcal{L} = \mathbf{x}^T\mathbf{Q}\mathbf{x} + \mathbf{u}^T\mathbf{R}\mathbf{u} + \boldsymbol{\lambda}^T(\mathbf{A}\mathbf{x} + \mathbf{B}\mathbf{u} - \dot{\mathbf{x}})$$

**最適条件：**
$$\frac{\partial \mathcal{L}}{\partial \mathbf{u}} = 2\mathbf{R}\mathbf{u} + \mathbf{B}^T\boldsymbol{\lambda} = \mathbf{0} \Rightarrow \mathbf{u}^* = -\frac{1}{2}\mathbf{R}^{-1}\mathbf{B}^T\boldsymbol{\lambda}$$

**随伴方程式：**
$$\dot{\boldsymbol{\lambda}} = -\frac{\partial \mathcal{L}}{\partial \mathbf{x}} = -2\mathbf{Q}\mathbf{x} - \mathbf{A}^T\boldsymbol{\lambda}$$

### 3.2 動的計画法によるアプローチ

**価値関数（Value Function）：**
$$V(\mathbf{x}, t) = \min_{\mathbf{u}} \int_t^\infty \left[ \mathbf{x}^T\mathbf{Q}\mathbf{x} + \mathbf{u}^T\mathbf{R}\mathbf{u} \right] d\tau$$

**ベルマンの最適性原理：**
$$V(\mathbf{x}, t) = \min_{\mathbf{u}} \left\{ \mathbf{x}^T\mathbf{Q}\mathbf{x} + \mathbf{u}^T\mathbf{R}\mathbf{u} + \frac{\partial V}{\partial \mathbf{x}}^T (\mathbf{A}\mathbf{x} + \mathbf{B}\mathbf{u}) \right\} \Delta t$$

**ハミルトン-ヤコビ-ベルマン（HJB）方程式：**
$$0 = \min_{\mathbf{u}} \left\{ \mathbf{x}^T\mathbf{Q}\mathbf{x} + \mathbf{u}^T\mathbf{R}\mathbf{u} + \frac{\partial V}{\partial \mathbf{x}}^T (\mathbf{A}\mathbf{x} + \mathbf{B}\mathbf{u}) \right\}$$

**最適化：**
$$\frac{\partial}{\partial \mathbf{u}} = 2\mathbf{R}\mathbf{u} + \mathbf{B}^T\frac{\partial V}{\partial \mathbf{x}} = \mathbf{0} \Rightarrow \mathbf{u}^* = -\frac{1}{2}\mathbf{R}^{-1}\mathbf{B}^T\frac{\partial V}{\partial \mathbf{x}}$$

**二次形式の仮定：**
$$V(\mathbf{x}) = \mathbf{x}^T\mathbf{P}\mathbf{x}$$

とすると、$\frac{\partial V}{\partial \mathbf{x}} = 2\mathbf{P}\mathbf{x}$

したがって：
$$\mathbf{u}^* = -\mathbf{R}^{-1}\mathbf{B}^T\mathbf{P}\mathbf{x}$$

HJB方程式に代入すると、リッカチ方程式が導出されます。

## 4. ハミルトン行列とリッカチ方程式

### 4.1 ハミルトン行列

$$\mathbf{H} = \begin{bmatrix} \mathbf{A} & -\mathbf{B}\mathbf{R}^{-1}\mathbf{B}^T \\ -\mathbf{Q} & -\mathbf{A}^T \end{bmatrix}$$

**性質：**
- $2n \times 2n$ 行列
- 固有値は実軸に関して対称（$\lambda$ が固有値なら $-\lambda$ も固有値）
- $n$ 個の固有値が左半平面、$n$ 個が右半平面に存在（可制御・可観測の場合）

### 4.2 リッカチ方程式の解との関係

ハミルトン行列の固有ベクトルを用いてリッカチ方程式の解を構成できます。

左半平面の固有値に対応する固有ベクトルを並べた行列：
$$\mathbf{H}\begin{bmatrix} \mathbf{X} \\ \mathbf{Y} \end{bmatrix} = \begin{bmatrix} \mathbf{X} \\ \mathbf{Y} \end{bmatrix}\boldsymbol{\Lambda}$$

ここで、$\boldsymbol{\Lambda}$ は左半平面の固有値の対角行列です。

リッカチ方程式の解：
$$\mathbf{P} = \mathbf{Y}\mathbf{X}^{-1}$$

### 4.3 数値解法

**Schur分解法：**
1. ハミルトン行列 $\mathbf{H}$ を実Schur形式に分解
2. 安定部分空間（左半平面の固有値に対応）を抽出
3. $\mathbf{P} = \mathbf{Y}\mathbf{X}^{-1}$ を計算

この方法は数値的に安定で、広く使用されています。

## 5. リッカチ方程式の反復解法

### 5.1 ニュートン法

リッカチ方程式を $\mathbf{F}(\mathbf{P}) = \mathbf{0}$ と書くと：

$$\mathbf{F}(\mathbf{P}) = \mathbf{A}^T\mathbf{P} + \mathbf{P}\mathbf{A} - \mathbf{P}\mathbf{B}\mathbf{R}^{-1}\mathbf{B}^T\mathbf{P} + \mathbf{Q}$$

ニュートン法の反復：
$$\mathbf{P}^{(k+1)} = \mathbf{P}^{(k)} - \left[ \frac{\partial \mathbf{F}}{\partial \mathbf{P}} \right]^{-1}\mathbf{F}(\mathbf{P}^{(k)})$$

### 5.2 クラインマンアルゴリズム

**アルゴリズム：**

1. 安定化ゲイン $\mathbf{K}_0$ を初期値として選ぶ
2. リアプノフ方程式を解く：
   $$(\mathbf{A} - \mathbf{B}\mathbf{K}_k)^T\mathbf{P}_k + \mathbf{P}_k(\mathbf{A} - \mathbf{B}\mathbf{K}_k) = -(\mathbf{Q} + \mathbf{K}_k^T\mathbf{R}\mathbf{K}_k)$$
3. 新しいゲインを計算：
   $$\mathbf{K}_{k+1} = \mathbf{R}^{-1}\mathbf{B}^T\mathbf{P}_k$$
4. 収束するまで繰り返す

**特徴：**
- 各ステップがリアプノフ方程式（線形）
- 二次収束
- 初期ゲインが安定化すれば、常に収束

## 6. リッカチ方程式の感度解析

### 6.1 パラメータ感度

システムパラメータ $\mathbf{A}$, $\mathbf{B}$ や重み $\mathbf{Q}$, $\mathbf{R}$ の変化に対する解 $\mathbf{P}$ の感度：

$$\frac{\partial \mathbf{P}}{\partial \theta}$$

これは、ロバスト性の評価に重要です。

### 6.2 逆問題

与えられたゲイン $\mathbf{K}$ に対して、それを実現する重み $\mathbf{Q}$, $\mathbf{R}$ を求める問題。

**応用：**
- 経験的に設計したゲインを最適制御の枠組みで解釈
- ロバスト性の評価

## 7. 微分リッカチ方程式（DRE）

### 7.1 有限時間LQR

$$-\dot{\mathbf{P}}(t) = \mathbf{A}^T\mathbf{P}(t) + \mathbf{P}(t)\mathbf{A} - \mathbf{P}(t)\mathbf{B}\mathbf{R}^{-1}\mathbf{B}^T\mathbf{P}(t) + \mathbf{Q}$$

終端条件：$\mathbf{P}(T) = \mathbf{S}$

### 7.2 数値解法

**後退積分（Backward Integration）：**

時刻 $T$ から $t = 0$ へ向かって積分します。

**方法：**
- Runge-Kutta法
- 陰的積分法（剛性方程式の場合）

### 7.3 定常状態への収束

$T \to \infty$ のとき、$\mathbf{P}(t)$ は時不変の値に収束し、ARの解になります。

**収束速度：**

閉ループシステムの極（$\mathbf{A} - \mathbf{B}\mathbf{R}^{-1}\mathbf{B}^T\mathbf{P}$ の固有値）に依存します。

## 8. 一般化されたリッカチ方程式

### 8.1 クロスタームを含む場合

性能指標：
$$J = \int_0^\infty \left[ \mathbf{x}^T\mathbf{Q}\mathbf{x} + 2\mathbf{x}^T\mathbf{N}\mathbf{u} + \mathbf{u}^T\mathbf{R}\mathbf{u} \right] dt$$

リッカチ方程式：
$$\mathbf{A}^T\mathbf{P} + \mathbf{P}\mathbf{A} - (\mathbf{P}\mathbf{B} + \mathbf{N})\mathbf{R}^{-1}(\mathbf{B}^T\mathbf{P} + \mathbf{N}^T) + \mathbf{Q} = \mathbf{0}$$

### 8.2 特異LQR

$\mathbf{R}$ が特異（正則でない）場合の問題。

**特徴：**
- 制御入力に制約がない方向が存在
- 解の存在条件がより厳しい

## 9. 応用例

### 9.1 飛翔体の姿勢制御

人工衛星やロケットの姿勢制御にLQRが広く使用されています。

**状態変数：**
- 姿勢角、角速度

**制御入力：**
- スラスタやリアクションホイールのトルク

### 9.2 パワーシステムの安定化

電力系統の安定化制御にもLQRが応用されています。

**状態変数：**
- 発電機の位相角、角周波数

**制御入力：**
- 励磁電圧、PSS（Power System Stabilizer）

## 10. 演習問題

### 問題1
リッカチ方程式 $\mathbf{A}^T\mathbf{P} + \mathbf{P}\mathbf{A} - \mathbf{P}\mathbf{B}\mathbf{R}^{-1}\mathbf{B}^T\mathbf{P} + \mathbf{Q} = \mathbf{0}$ において、$\mathbf{P}$ が正定値ならば、閉ループシステム $\mathbf{A} - \mathbf{B}\mathbf{R}^{-1}\mathbf{B}^T\mathbf{P}$ が安定であることを示せ。

### 問題2
2次元システムに対して、ハミルトン行列を構成し、その固有値からリッカチ方程式の解を求めよ：
$$\mathbf{A} = \begin{bmatrix} 0 & 1 \\ -1 & -1 \end{bmatrix}, \quad \mathbf{B} = \begin{bmatrix} 0 \\ 1 \end{bmatrix}, \quad \mathbf{Q} = \mathbf{I}, \quad \mathbf{R} = 1$$

### 問題3
クラインマンアルゴリズムを実装し、数値的に収束を確認せよ。

## 11. まとめ

- リッカチ方程式は最適制御理論の核心
- ハミルトン行列の固有値問題として解ける
- 動的計画法とHJB方程式から導出される
- 数値解法にはSchur分解法やニュートン法がある
- 有限時間問題では微分リッカチ方程式を解く
- 多くの実用システムで応用されている

## 次回予告

次回は、**カルマンフィルタ**について学びます。最適推定理論の基礎となる重要な手法です。

## 参考文献

1. Brian D.O. Anderson & John B. Moore, "Optimal Control: Linear Quadratic Methods"
2. Peter Lancaster & Leiba Rodman, "Algebraic Riccati Equations"
3. Huibert Kwakernaak & Raphael Sivan, "Linear Optimal Control Systems"
