# 第11回：オブザーバ

## 学習目標
- オブザーバ（状態推定器）の原理を理解する
- 同一次元オブザーバと最小次元オブザーバを学ぶ
- 分離定理を理解し、観測器併合制御系を設計する

## 1. はじめに

前回、状態フィードバック制御を学びましたが、実際のシステムではすべての状態変数を直接測定できるとは限りません。本講では、出力測定から状態を推定する**オブザーバ（observer）**または**状態推定器（state estimator）**の設計方法を学びます。

## 2. オブザーバの必要性

### 2.1 実用上の問題

- すべての状態変数にセンサを取り付けることは、コストや物理的制約から困難
- 一部の状態変数は測定不可能（内部温度、化学反応の中間生成物など）
- センサノイズを低減するためのフィルタとしても機能

### 2.2 オブザーバの役割

オブザーバは、以下の情報から状態を推定します：
- システムの数学モデル（$\mathbf{A}, \mathbf{B}, \mathbf{C}$）
- 制御入力 $\mathbf{u}(t)$
- 出力測定値 $\mathbf{y}(t)$

## 3. 同一次元オブザーバ（Full-Order Observer）

### 3.1 オブザーバの着想と基本構造

#### なぜオブザーバという考え方が生まれるのか？

実システムとまったく同じダイナミクスをもつ「模擬システム」を考えてみましょう：

**模擬システム（Open Loop Copy）：**
$$\dot{\tilde{\mathbf{x}}} = \mathbf{A}\tilde{\mathbf{x}} + \mathbf{B}\mathbf{u}$$

ここで、$\tilde{\mathbf{x}}$は模擬システムの状態です。理論的には、初期条件 $\tilde{\mathbf{x}}(0) = \mathbf{x}(0)$ と完全なモデル $(\mathbf{A}, \mathbf{B})$ があれば、$\tilde{\mathbf{x}}(t) = \mathbf{x}(t)$ となります。

**しかし、この方法には致命的な問題があります：**

1. **初期条件の不確実性**：$\mathbf{x}(0)$ が正確にわからない
2. **モデル誤差**：$\mathbf{A}, \mathbf{B}$ が不正確
3. **外乱の影響**：予期しない外乱が作用
4. **積分誤差**：時間とともに誤差が蓄積

これらの理由により、開ループの模擬システムでは実用的な状態推定ができません。

#### 出力フィードバックによる補正の必要性

そこで、**実測可能な出力情報を使って模擬システムを補正**するアイデアが生まれます：

**補正のメカニズム：**
```
実システム：   ẋ = Ax + Bu  →  y = Cx
模擬システム：  ẋ̂ = Ax̂ + Bu  →  ŷ = Cx̂
                      ↓
               補正項：L(y - ŷ)
```

模擬システムの出力 $\hat{\mathbf{y}} = \mathbf{C}\hat{\mathbf{x}}$ と実システムの出力 $\mathbf{y} = \mathbf{C}\mathbf{x}$ に差がある場合、これは推定に誤差があることを意味します。

**出力誤差 $\mathbf{y} - \hat{\mathbf{y}}$ の物理的意味：**
- $\mathbf{y} - \hat{\mathbf{y}} = \mathbf{C}(\mathbf{x} - \hat{\mathbf{x}}) = \mathbf{C}\mathbf{e}$
- これは状態推定誤差 $\mathbf{e} = \mathbf{x} - \hat{\mathbf{x}$ を出力空間で観測したもの
- この情報を使って推定状態を補正できる！

#### なぜ行列 **L** が重要なのか？

出力誤差 $(\mathbf{y} - \hat{\mathbf{y}})$ をそのまま状態に加えるわけにはいきません：

**次元の問題：**
- 状態 $\mathbf{x} \in \mathbb{R}^n$（例：n次元）
- 出力 $\mathbf{y} \in \mathbb{R}^p$（例：p次元、通常 $p < n$）

**行列 $\mathbf{L} \in \mathbb{R}^{n \times p}$ の役割：**
$$\mathbf{L}(\mathbf{y} - \hat{\mathbf{y}}) \in \mathbb{R}^n$$

行列 $\mathbf{L}$ は「出力誤差を状態空間の各成分にどのように分配するか」を決定します。

**直感的な理解：**
- $\mathbf{L}$ の各列は、対応する出力誤差成分が各状態推定値にどう影響するかを表す
- 例えば、$\mathbf{L}$ の第1列は、第1出力の誤差 $(y_1 - \hat{y}_1)$ が各状態推定値 $\hat{x}_1, \hat{x}_2, \ldots, \hat{x}_n$ に与える補正を表す

#### オブザーバの最終形

以上の考察から、**オブザーバ（状態推定器）**の構造が導かれます：

**システム：**
$$\dot{\mathbf{x}} = \mathbf{A}\mathbf{x} + \mathbf{B}\mathbf{u}$$
$$\mathbf{y} = \mathbf{C}\mathbf{x}$$

**オブザーバ：**
$$\dot{\hat{\mathbf{x}}} = \mathbf{A}\hat{\mathbf{x}} + \mathbf{B}\mathbf{u} + \mathbf{L}(\mathbf{y} - \hat{\mathbf{y}})$$
$$\hat{\mathbf{y}} = \mathbf{C}\hat{\mathbf{x}}$$

**各項の物理的意味：**
- $\mathbf{A}\hat{\mathbf{x}}$：推定状態の自然な発展（システムの内在ダイナミクス）
- $\mathbf{B}\mathbf{u}$：制御入力の既知の効果
- $\mathbf{L}(\mathbf{y} - \hat{\mathbf{y}})$：出力測定に基づく推定補正
  - $\mathbf{y} - \hat{\mathbf{y}}$：**イノベーション**（新しい情報）
  - $\mathbf{L}$：**オブザーバゲイン**（補正の強さと方向を制御）

この構造により、オブザーバは「予測」（モデルベース）と「補正」（測定ベース）を組み合わせた推定器となります。

### 3.2 推定誤差のダイナミクス

#### なぜ誤差の解析が重要か？

オブザーバが「良い推定器」であるためには、推定誤差 $\mathbf{e} = \mathbf{x} - \hat{\mathbf{x}}$ が時間とともに0に収束する必要があります。この挙動を理解するために、誤差のダイナミクスを詳しく調べます。

#### 誤差ダイナミクスの導出

**Step 1: 実システムと推定システムの方程式**
```
実システム：    ẋ = Ax + Bu
推定システム：   x̂̇ = Ax̂ + Bu + L(y - ŷ)
```

**Step 2: 推定誤差の時間微分**

推定誤差 $\mathbf{e} = \mathbf{x} - \hat{\mathbf{x}}$ の時間微分：

$$\dot{\mathbf{e}} = \dot{\mathbf{x}} - \dot{\hat{\mathbf{x}}}$$

**Step 3: 各項を代入**

$$\dot{\mathbf{e}} = \mathbf{A}\mathbf{x} + \mathbf{B}\mathbf{u} - [\mathbf{A}\hat{\mathbf{x}} + \mathbf{B}\mathbf{u} + \mathbf{L}(\mathbf{y} - \hat{\mathbf{y}})]$$

**Step 4: 項をまとめる**

$$\dot{\mathbf{e}} = \mathbf{A}(\mathbf{x} - \hat{\mathbf{x}}) + \mathbf{B}\mathbf{u} - \mathbf{B}\mathbf{u} - \mathbf{L}(\mathbf{y} - \hat{\mathbf{y}})$$

$$= \mathbf{A}\mathbf{e} - \mathbf{L}(\mathbf{y} - \hat{\mathbf{y}})$$

**Step 5: 出力誤差を状態誤差で表現**

$\mathbf{y} = \mathbf{C}\mathbf{x}$, $\hat{\mathbf{y}} = \mathbf{C}\hat{\mathbf{x}}$ なので：

$$\mathbf{y} - \hat{\mathbf{y}} = \mathbf{C}\mathbf{x} - \mathbf{C}\hat{\mathbf{x}} = \mathbf{C}(\mathbf{x} - \hat{\mathbf{x}}) = \mathbf{C}\mathbf{e}$$

**Step 6: 最終的な誤差ダイナミクス**

$$\dot{\mathbf{e}} = \mathbf{A}\mathbf{e} - \mathbf{L}\mathbf{C}\mathbf{e} = (\mathbf{A} - \mathbf{L}\mathbf{C})\mathbf{e}$$

#### この結果の深い意味

**重要な観察：**

1. **入力独立性**：推定誤差のダイナミクスは制御入力 $\mathbf{u}$ に依存しない
   - これは非常に重要な性質
   - 制御入力がどのように変化しても、推定精度に影響しない
   - オブザーバの設計が制御器の設計と独立に行える基盤

2. **誤差の自律システム**：$\dot{\mathbf{e}} = (\mathbf{A} - \mathbf{L}\mathbf{C})\mathbf{e}$ は自律的な線形システム
   - 誤差は指数的に変化（収束または発散）
   - 行列 $(\mathbf{A} - \mathbf{L}\mathbf{C})$ の固有値で挙動が決まる

3. **設計パラメータ**：行列 $\mathbf{L}$ が誤差のダイナミクスを完全に制御
   - $\mathbf{L}$ を適切に選ぶことで、$\mathbf{e}(t) \to \mathbf{0}$ とできる
   - これがオブザーバ設計の核心

#### 物理的解釈

誤差ダイナミクス $\dot{\mathbf{e}} = (\mathbf{A} - \mathbf{L}\mathbf{C})\mathbf{e}$ の各項：

- **$\mathbf{A}\mathbf{e}$項**：システム本来のダイナミクスによる誤差の自然な発展
  - $\mathbf{A}$ が不安定なら、この項は誤差を増大させる
  
- **$-\mathbf{L}\mathbf{C}\mathbf{e}$項**：測定に基づく補正効果
  - 出力測定を通じて誤差情報を取得し、それを状態空間にフィードバック
  - $\mathbf{L}$ が大きいほど、強い補正が働く

この競合により、適切な $\mathbf{L}$ を選ぶことで誤差を安定に収束させることができます。

### 3.3 オブザーバの極配置

推定誤差が減衰するためには、$\mathbf{A} - \mathbf{L}\mathbf{C}$ が安定である必要があります。

**オブザーバ設計定理：**

システム $(\mathbf{A}, \mathbf{C})$ が可観測ならば、任意の極の集合に対して、$\mathbf{A} - \mathbf{L}\mathbf{C}$ の固有値を希望する位置に配置するオブザーバゲイン $\mathbf{L}$ が存在する。

**設計手順：**

双対性を利用します。$(\mathbf{A}, \mathbf{C})$ が可観測 ⇔ $(\mathbf{A}^T, \mathbf{C}^T)$ が可制御

したがって、状態フィードバックの極配置法を双対システムに適用：

1. 双対システム $(\mathbf{A}^T, \mathbf{C}^T)$ に対してゲイン $\mathbf{K}^T$ を設計
2. $\mathbf{L} = \mathbf{K}^T$ とする

### 3.4 Ackermannの公式（オブザーバ版）

$$\mathbf{L} = \alpha_o(\mathbf{A})\mathbf{O}^{-1}\begin{bmatrix} 0 \\ 0 \\ \vdots \\ 0 \\ 1 \end{bmatrix}$$

ここで：
- $\mathbf{O} = \begin{bmatrix} \mathbf{C}^T & (\mathbf{C}\mathbf{A})^T & \cdots & (\mathbf{C}\mathbf{A}^{n-1})^T \end{bmatrix}$：可観測性行列の転置
- $\alpha_o(\mathbf{A})$：希望する特性多項式を $\mathbf{A}$ に代入

## 4. オブザーバの極の選択

### 4.1 基本的な考え方

オブザーバの極は、制御器の極よりも速く（左側に）配置するのが一般的です。

**理由：**
- 推定誤差を素早く減衰させる
- フィードバック制御が正確な状態推定に基づいて動作する

**経験則：**
- オブザーバの極の実部を、制御器の極の実部の2～5倍に設定

### 4.2 注意事項

- 極を左側に配置しすぎると、センサノイズを増幅
- モデル化誤差の影響が大きくなる
- トレードオフの考慮が必要

## 5. 最小次元オブザーバ（Reduced-Order Observer）

### 5.1 動機

出力 $\mathbf{y}$ は直接測定されているため、これらの状態については推定不要です。測定されていない状態のみを推定する**最小次元オブザーバ**が効率的です。

### 5.2 状態の分割

状態を測定される部分と測定されない部分に分割：

$$\mathbf{x} = \begin{bmatrix} \mathbf{x}_a \\ \mathbf{x}_b \end{bmatrix}, \quad \mathbf{y} = \mathbf{x}_a$$

ここで、$\mathbf{x}_a \in \mathbb{R}^p$（測定される）、$\mathbf{x}_b \in \mathbb{R}^{n-p}$（測定されない）

### 5.3 システムの分割

$$\begin{bmatrix} \dot{\mathbf{x}}_a \\ \dot{\mathbf{x}}_b \end{bmatrix} = \begin{bmatrix} \mathbf{A}_{aa} & \mathbf{A}_{ab} \\ \mathbf{A}_{ba} & \mathbf{A}_{bb} \end{bmatrix}\begin{bmatrix} \mathbf{x}_a \\ \mathbf{x}_b \end{bmatrix} + \begin{bmatrix} \mathbf{B}_a \\ \mathbf{B}_b \end{bmatrix}\mathbf{u}$$

測定されない状態のダイナミクス：

$$\dot{\mathbf{x}}_b = \mathbf{A}_{ba}\mathbf{x}_a + \mathbf{A}_{bb}\mathbf{x}_b + \mathbf{B}_b\mathbf{u}$$

### 5.4 最小次元オブザーバの構造

$$\dot{\hat{\mathbf{x}}}_b = \mathbf{A}_{bb}\hat{\mathbf{x}}_b + \mathbf{A}_{ba}\mathbf{y} + \mathbf{B}_b\mathbf{u} + \mathbf{L}_r(\dot{\mathbf{y}} - \mathbf{A}_{aa}\mathbf{y} - \mathbf{A}_{ab}\hat{\mathbf{x}}_b - \mathbf{B}_a\mathbf{u})$$

ただし、$\dot{\mathbf{y}}$ の微分が必要なため、実装が難しい。

**実用的な形式：**

補助変数 $\mathbf{z} = \hat{\mathbf{x}}_b - \mathbf{L}_r\mathbf{y}$ を導入すると、微分を含まない形式になります。

## 6. 観測器併合制御系（Observer-Based Controller）

### 6.1 制御器とオブザーバの統合

状態フィードバック制御：
$$\mathbf{u} = -\mathbf{K}\mathbf{x}$$

オブザーバで推定した状態を使用：
$$\mathbf{u} = -\mathbf{K}\hat{\mathbf{x}}$$

### 6.2 全体のシステム

元のシステム：
$$\dot{\mathbf{x}} = \mathbf{A}\mathbf{x} + \mathbf{B}\mathbf{u} = \mathbf{A}\mathbf{x} - \mathbf{B}\mathbf{K}\hat{\mathbf{x}}$$

オブザーバ：
$$\dot{\hat{\mathbf{x}}} = \mathbf{A}\hat{\mathbf{x}} + \mathbf{B}\mathbf{u} + \mathbf{L}(\mathbf{y} - \mathbf{C}\hat{\mathbf{x}})$$
$$= (\mathbf{A} - \mathbf{B}\mathbf{K} - \mathbf{L}\mathbf{C})\hat{\mathbf{x}} + \mathbf{L}\mathbf{C}\mathbf{x}$$

拡大システム：
$$\begin{bmatrix} \dot{\mathbf{x}} \\ \dot{\mathbf{e}} \end{bmatrix} = \begin{bmatrix} \mathbf{A} - \mathbf{B}\mathbf{K} & \mathbf{B}\mathbf{K} \\ \mathbf{0} & \mathbf{A} - \mathbf{L}\mathbf{C} \end{bmatrix}\begin{bmatrix} \mathbf{x} \\ \mathbf{e} \end{bmatrix}$$

ここで、$\mathbf{e} = \mathbf{x} - \hat{\mathbf{x}}$

### 6.3 分離定理（Separation Principle）

**定理：**

観測器併合制御系の極は、制御器の極（$\mathbf{A} - \mathbf{B}\mathbf{K}$ の固有値）とオブザーバの極（$\mathbf{A} - \mathbf{L}\mathbf{C}$ の固有値）の和集合である。

**意味：**
- 制御器とオブザーバの設計を独立に行える
- それぞれを別々に最適化して、組み合わせることができる

## 7. 具体例

### 7.1 例題

システム：
$$\mathbf{A} = \begin{bmatrix} 0 & 1 \\ -2 & -3 \end{bmatrix}, \quad \mathbf{B} = \begin{bmatrix} 0 \\ 1 \end{bmatrix}, \quad \mathbf{C} = \begin{bmatrix} 1 & 0 \end{bmatrix}$$

**制御器設計：** 極を $\lambda_1 = -2$, $\lambda_2 = -3$ に配置

Ackermannの公式により：$\mathbf{K} = \begin{bmatrix} 4 & 3 \end{bmatrix}$

**オブザーバ設計：** 極を $\lambda_1 = -6$, $\lambda_2 = -7$ に配置（制御器の2倍速）

双対性とAckermannの公式により：$\mathbf{L} = \begin{bmatrix} 11 \\ 36 \end{bmatrix}$

**観測器併合制御系の極：** $\{-2, -3, -6, -7\}$

## 8. カルマンフィルタとの関係

### 8.1 決定論的オブザーバ vs 確率的オブザーバ

- **Luenbergerオブザーバ**（本講義）：決定論的、極配置による設計
- **カルマンフィルタ**（次回以降）：確率的、ノイズ統計に基づく最適設計

### 8.2 統一的視点

カルマンフィルタは、オブザーバゲイン $\mathbf{L}$ を最適化問題の解として与えます（最小分散推定）。

## 9. 演習問題

### 問題1
以下のシステムに対して、オブザーバの極を $\lambda_1 = -5$, $\lambda_2 = -6$ に配置するオブザーバゲイン $\mathbf{L}$ を求めよ：
$$\mathbf{A} = \begin{bmatrix} 0 & 1 \\ -1 & -2 \end{bmatrix}, \quad \mathbf{C} = \begin{bmatrix} 1 & 0 \end{bmatrix}$$

### 問題2
分離定理が成り立つ理由を、拡大システムの行列の構造から説明せよ。

### 問題3
オブザーバの極を制御器の極よりも速く設定する理由を、物理的・工学的観点から説明せよ。

## 10. まとめ

- オブザーバは、出力測定からシステムの状態を推定する
- 同一次元オブザーバは、すべての状態を推定
- 最小次元オブザーバは、測定されない状態のみを推定
- オブザーバの極配置は、可観測性が条件
- 分離定理により、制御器とオブザーバを独立に設計可能
- オブザーバの極は制御器より速く設定するのが一般的

## 次回予告

次回は、**最適レギュレータ**について学びます。制御性能を最大化する系統的な制御器設計手法です。

## 参考文献

1. Katsuhiko Ogata, "Modern Control Engineering"
2. 児玉慎三・須田信英『システム制御理論入門』コロナ社
3. Gene F. Franklin et al., "Feedback Control of Dynamic Systems"
