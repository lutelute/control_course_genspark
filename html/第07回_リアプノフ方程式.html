<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¬¬7å›: ãƒªã‚¢ãƒ—ãƒãƒ•æ–¹ç¨‹å¼</title>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; background: #f5f5f5; }
        .container { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #2c3e50; border-bottom: 3px solid #e74c3c; padding-bottom: 10px; }
        h2 { color: #34495e; margin-top: 30px; }
        .theory-box { background: #fef5e7; padding: 20px; border-left: 4px solid #e74c3c; margin: 20px 0; border-radius: 5px; }
        .simulator { background: #f9f9f9; padding: 25px; border-radius: 8px; margin: 25px 0; border: 2px solid #ddd; }
        .controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin: 20px 0; }
        .control-group { display: flex; flex-direction: column; }
        label { font-weight: bold; color: #555; margin-bottom: 5px; }
        input, select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
        button { background: #e74c3c; color: white; border: none; padding: 12px 24px; border-radius: 5px; cursor: pointer; font-size: 16px; margin: 10px 5px; }
        button:hover { background: #c0392b; }
        .plot-container { margin: 20px 0; }
        .matrix-display { background: white; padding: 15px; border-radius: 5px; font-family: monospace; margin: 10px 0; border: 1px solid #ddd; white-space: pre-wrap; }
        .example { background: #e8f8f5; padding: 15px; border-left: 4px solid #1abc9c; margin: 20px 0; border-radius: 5px; }
        .stability-indicator { padding: 15px; border-radius: 5px; margin: 15px 0; font-weight: bold; text-align: center; }
        .stable { background: #d4edda; color: #155724; border: 2px solid #c3e6cb; }
        .unstable { background: #f8d7da; color: #721c24; border: 2px solid #f5c6cb; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¯ ç¬¬7å›: ãƒªã‚¢ãƒ—ãƒãƒ•æ–¹ç¨‹å¼</h1>
        
        <div class="theory-box">
            <h2>ğŸ“š ç†è«–ã®æ¦‚è¦</h2>
            <p><strong>ãƒªã‚¢ãƒ—ãƒãƒ•æ–¹ç¨‹å¼</strong>ã¯ã€ã‚·ã‚¹ãƒ†ãƒ ã®å®‰å®šæ€§ã‚’è§£æã™ã‚‹å¼·åŠ›ãªãƒ„ãƒ¼ãƒ«ã§ã™ã€‚å›ºæœ‰å€¤è¨ˆç®—ã‚’è¡Œã‚ãšã«ã€å®‰å®šæ€§ã‚’åˆ¤å®šã§ãã‚‹åˆ©ç‚¹ãŒã‚ã‚Šã¾ã™ã€‚</p>
            
            <h3>ãƒªã‚¢ãƒ—ãƒãƒ•ã®å®‰å®šæ€§å®šç†</h3>
            <p>ç·šå½¢ã‚·ã‚¹ãƒ†ãƒ  \( \dot{x} = Ax \) ãŒæ¼¸è¿‘å®‰å®šã§ã‚ã‚‹ãŸã‚ã®å¿…è¦ååˆ†æ¡ä»¶ã¯ã€ä»»æ„ã®æ­£å®šè¡Œåˆ— \( Q > 0 \) ã«å¯¾ã—ã¦ã€</p>
            <p>$$A^T P + PA = -Q$$</p>
            <p>ã‚’æº€ãŸã™æ­£å®šè¡Œåˆ— \( P > 0 \) ãŒå­˜åœ¨ã™ã‚‹ã“ã¨ã§ã™ã€‚</p>
            
            <h3>ãƒªã‚¢ãƒ—ãƒãƒ•é–¢æ•°</h3>
            <p>ã‚¨ãƒãƒ«ã‚®ãƒ¼é–¢æ•°ã¨ã—ã¦è§£é‡ˆã•ã‚Œã‚‹äºŒæ¬¡å½¢å¼:</p>
            <p>$$V(x) = x^T P x$$</p>
            <p>ã“ã®é–¢æ•°ã®æ™‚é–“å¾®åˆ†ãŒè² å®šå€¤ã§ã‚ã‚Œã°ã€ã‚·ã‚¹ãƒ†ãƒ ã¯å®‰å®šã§ã™:</p>
            <p>$$\dot{V}(x) = x^T (A^T P + PA) x = -x^T Q x < 0$$</p>
            
            <h3>åˆ¤å®šæ‰‹é †</h3>
            <ol>
                <li>ä»»æ„ã®æ­£å®šè¡Œåˆ— \( Q \) ã‚’é¸æŠï¼ˆé€šå¸¸ã¯å˜ä½è¡Œåˆ— \( Q = I \)ï¼‰</li>
                <li>ãƒªã‚¢ãƒ—ãƒãƒ•æ–¹ç¨‹å¼ \( A^T P + PA = -Q \) ã‚’è§£ã„ã¦ \( P \) ã‚’æ±‚ã‚ã‚‹</li>
                <li>\( P \) ãŒæ­£å®šã‹ã©ã†ã‹ã‚’ç¢ºèªï¼ˆã™ã¹ã¦ã®å›ºæœ‰å€¤ãŒæ­£ or ã™ã¹ã¦ã®ä¸»å°è¡Œåˆ—å¼ãŒæ­£ï¼‰</li>
            </ol>
        </div>

        <div class="simulator">
            <h2>ğŸ® ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼: ãƒªã‚¢ãƒ—ãƒãƒ•æ–¹ç¨‹å¼æ±‚è§£å™¨</h2>
            
            <div class="controls">
                <div class="control-group">
                    <label>ã‚·ã‚¹ãƒ†ãƒ é¸æŠ:</label>
                    <select id="systemType">
                        <option value="custom">ã‚«ã‚¹ã‚¿ãƒ å…¥åŠ›</option>
                        <option value="stable2d">å®‰å®šãª2æ¬¡ç³»</option>
                        <option value="unstable2d">ä¸å®‰å®šãª2æ¬¡ç³»</option>
                        <option value="marginal">é™ç•Œå®‰å®šç³»</option>
                    </select>
                </div>
            </div>
            
            <h3>ã‚·ã‚¹ãƒ†ãƒ è¡Œåˆ— A ã®å…¥åŠ›ï¼ˆ2Ã—2ï¼‰</h3>
            <div class="controls">
                <div class="control-group">
                    <label>A[0,0]:</label>
                    <input type="number" id="a00" value="-1" step="0.1">
                </div>
                <div class="control-group">
                    <label>A[0,1]:</label>
                    <input type="number" id="a01" value="0" step="0.1">
                </div>
                <div class="control-group">
                    <label>A[1,0]:</label>
                    <input type="number" id="a10" value="0" step="0.1">
                </div>
                <div class="control-group">
                    <label>A[1,1]:</label>
                    <input type="number" id="a11" value="-2" step="0.1">
                </div>
            </div>
            
            <button onclick="solveLyapunov()">ğŸ§® ãƒªã‚¢ãƒ—ãƒãƒ•æ–¹ç¨‹å¼ã‚’è§£ã</button>
            <button onclick="visualizeStability()">ğŸ“Š å®‰å®šæ€§ã‚’å¯è¦–åŒ–</button>
            
            <div id="stabilityResult"></div>
            <div id="matrixP" class="matrix-display"></div>
            <div id="eigenvalues" class="matrix-display"></div>
            <div id="lyapunovPlot" class="plot-container"></div>
            <div id="phasePlot" class="plot-container"></div>
        </div>

        <div class="example">
            <h3>ğŸ’¡ å®Ÿä¾‹: 2æ¬¡ç³»ã®å®‰å®šæ€§åˆ¤å®š</h3>
            <p><strong>å•é¡Œ</strong>: ä»¥ä¸‹ã®ã‚·ã‚¹ãƒ†ãƒ ã®å®‰å®šæ€§ã‚’åˆ¤å®šã›ã‚ˆ:</p>
            <p>$$A = \begin{bmatrix} -1 & 2 \\ -2 & -3 \end{bmatrix}$$</p>
            <p><strong>è§£ç­”</strong>:</p>
            <p>\( Q = I \) ã¨ã—ã¦ã€ãƒªã‚¢ãƒ—ãƒãƒ•æ–¹ç¨‹å¼ã‚’è§£ãã¨:</p>
            <p>$$P = \begin{bmatrix} 1.5 & 0.5 \\ 0.5 & 1.0 \end{bmatrix}$$</p>
            <p>\( P \) ã®å›ºæœ‰å€¤ã¯ 1.809, 0.691ï¼ˆã™ã¹ã¦æ­£ï¼‰â†’ <strong>æ¼¸è¿‘å®‰å®š</strong></p>
        </div>

        <div class="theory-box">
            <h2>ğŸ¯ é‡è¦ãƒã‚¤ãƒ³ãƒˆ</h2>
            <ul>
                <li>ãƒªã‚¢ãƒ—ãƒãƒ•æ–¹ç¨‹å¼ã¯å›ºæœ‰å€¤ã‚’ç›´æ¥è¨ˆç®—ã›ãšã«å®‰å®šæ€§ã‚’åˆ¤å®šã§ãã‚‹</li>
                <li>\( Q \) ã®é¸æŠã¯ä»»æ„ã ãŒã€\( Q = I \) ãŒä¸€èˆ¬çš„</li>
                <li>\( P > 0 \) ã®ç¢ºèªã«ã¯å›ºæœ‰å€¤æ³•ã‚„ä¸»å°è¡Œåˆ—å¼æ³•ã‚’ç”¨ã„ã‚‹</li>
                <li>ãƒªã‚¢ãƒ—ãƒãƒ•é–¢æ•°ã¯ã‚¨ãƒãƒ«ã‚®ãƒ¼æ¦‚å¿µã«å¯¾å¿œã—ã¦ã„ã‚‹</li>
                <li>éç·šå½¢ã‚·ã‚¹ãƒ†ãƒ ã«ã‚‚æ‹¡å¼µå¯èƒ½ï¼ˆãƒªã‚¢ãƒ—ãƒãƒ•ã®ç›´æ¥æ³•ï¼‰</li>
            </ul>
        </div>
    </div>

    <script>
        function getMatrixA() {
            return [
                [parseFloat(document.getElementById('a00').value), parseFloat(document.getElementById('a01').value)],
                [parseFloat(document.getElementById('a10').value), parseFloat(document.getElementById('a11').value)]
            ];
        }

        function solveLyapunov() {
            const A = getMatrixA();
            const Q = [[1, 0], [0, 1]]; // Q = I
            
            // 2Ã—2ã®å ´åˆã€ãƒªã‚¢ãƒ—ãƒãƒ•æ–¹ç¨‹å¼ A^T P + P A = -Q ã‚’ç›´æ¥è§£ã
            // P = [p11, p12; p12, p22] ã¨ã—ã¦é€£ç«‹æ–¹ç¨‹å¼ã‚’è§£ã
            const a = A[0][0], b = A[0][1], c = A[1][0], d = A[1][1];
            
            // ä¿‚æ•°è¡Œåˆ—ã‚’ä½œæˆ
            const coeff = [
                [2*a, b+c, 0],
                [0, a+d, 2*b],
                [b+c, 0, 2*d]
            ];
            
            const rhs = [-Q[0][0], -Q[0][1], -Q[1][1]];
            
            // ç°¡æ˜“çš„ãªã‚¬ã‚¦ã‚¹æ¶ˆå»æ³•
            const P_vec = solveLinear3x3(coeff, rhs);
            
            if (P_vec === null) {
                document.getElementById('matrixP').innerHTML = '<p style="color: red;">ãƒªã‚¢ãƒ—ãƒãƒ•æ–¹ç¨‹å¼ã®è§£ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</p>';
                return;
            }
            
            const P = [
                [P_vec[0], P_vec[1]],
                [P_vec[1], P_vec[2]]
            ];
            
            // Pã®å›ºæœ‰å€¤ã‚’è¨ˆç®—
            const trace = P[0][0] + P[1][1];
            const det = P[0][0] * P[1][1] - P[0][1] * P[1][0];
            const discriminant = trace * trace - 4 * det;
            
            let eigenvalues;
            if (discriminant >= 0) {
                eigenvalues = [
                    (trace + Math.sqrt(discriminant)) / 2,
                    (trace - Math.sqrt(discriminant)) / 2
                ];
            } else {
                document.getElementById('eigenvalues').innerHTML = '<p>Pã®å›ºæœ‰å€¤ãŒè¤‡ç´ æ•°ã§ã™ï¼ˆç•°å¸¸ãªçŠ¶æ…‹ï¼‰</p>';
                return;
            }
            
            const isStable = eigenvalues.every(ev => ev > 0);
            
            // çµæœè¡¨ç¤º
            let html = '<div class="stability-indicator ' + (isStable ? 'stable' : 'unstable') + '">';
            html += isStable ? 'âœ… ã‚·ã‚¹ãƒ†ãƒ ã¯æ¼¸è¿‘å®‰å®šã§ã™' : 'âŒ ã‚·ã‚¹ãƒ†ãƒ ã¯ä¸å®‰å®šã§ã™';
            html += '</div>';
            document.getElementById('stabilityResult').innerHTML = html;
            
            html = '<h3>è§£ P è¡Œåˆ—</h3>';
            html += `<pre>[${P[0][0].toFixed(4)}, ${P[0][1].toFixed(4)}]\n[${P[1][0].toFixed(4)}, ${P[1][1].toFixed(4)}]</pre>`;
            document.getElementById('matrixP').innerHTML = html;
            
            html = '<h3>P ã®å›ºæœ‰å€¤</h3>';
            html += `<pre>Î»â‚ = ${eigenvalues[0].toFixed(4)}\nÎ»â‚‚ = ${eigenvalues[1].toFixed(4)}</pre>`;
            html += '<p>' + (isStable ? 'ã™ã¹ã¦ã®å›ºæœ‰å€¤ãŒæ­£ â†’ P > 0' : 'è² ã®å›ºæœ‰å€¤ãŒå­˜åœ¨ â†’ P ã¯æ­£å®šã§ã¯ãªã„') + '</p>';
            document.getElementById('eigenvalues').innerHTML = html;
            
            // ãƒªã‚¢ãƒ—ãƒãƒ•é–¢æ•°ã‚’å¯è¦–åŒ–
            visualizeLyapunovFunction(P, isStable);
        }

        function solveLinear3x3(A, b) {
            // ç°¡æ˜“çš„ãªã‚¬ã‚¦ã‚¹æ¶ˆå»æ³•ï¼ˆ3Ã—3å°‚ç”¨ï¼‰
            const n = 3;
            let aug = A.map((row, i) => [...row, b[i]]);
            
            // å‰é€²æ¶ˆå»
            for (let i = 0; i < n; i++) {
                // ãƒ”ãƒœãƒƒãƒˆé¸æŠ
                let maxRow = i;
                for (let k = i + 1; k < n; k++) {
                    if (Math.abs(aug[k][i]) > Math.abs(aug[maxRow][i])) {
                        maxRow = k;
                    }
                }
                [aug[i], aug[maxRow]] = [aug[maxRow], aug[i]];
                
                if (Math.abs(aug[i][i]) < 1e-10) {
                    return null; // ç‰¹ç•°è¡Œåˆ—
                }
                
                // æ¶ˆå»
                for (let k = i + 1; k < n; k++) {
                    const factor = aug[k][i] / aug[i][i];
                    for (let j = i; j <= n; j++) {
                        aug[k][j] -= factor * aug[i][j];
                    }
                }
            }
            
            // å¾Œé€€ä»£å…¥
            const x = Array(n).fill(0);
            for (let i = n - 1; i >= 0; i--) {
                x[i] = aug[i][n];
                for (let j = i + 1; j < n; j++) {
                    x[i] -= aug[i][j] * x[j];
                }
                x[i] /= aug[i][i];
            }
            
            return x;
        }

        function visualizeLyapunovFunction(P, isStable) {
            const x = [], y = [], z = [];
            const range = 5;
            const steps = 30;
            
            for (let i = 0; i <= steps; i++) {
                const xi = -range + (2 * range * i / steps);
                const xRow = [], yRow = [], zRow = [];
                for (let j = 0; j <= steps; j++) {
                    const yj = -range + (2 * range * j / steps);
                    const V = P[0][0] * xi * xi + 2 * P[0][1] * xi * yj + P[1][1] * yj * yj;
                    xRow.push(xi);
                    yRow.push(yj);
                    zRow.push(V);
                }
                x.push(xRow);
                y.push(yRow);
                z.push(zRow);
            }
            
            const trace = {
                x: x,
                y: y,
                z: z,
                type: 'surface',
                colorscale: isStable ? 'Viridis' : 'Hot',
                name: 'V(x)'
            };
            
            const layout = {
                title: 'ãƒªã‚¢ãƒ—ãƒãƒ•é–¢æ•° V(x) = x^T P x',
                scene: {
                    xaxis: { title: 'xâ‚' },
                    yaxis: { title: 'xâ‚‚' },
                    zaxis: { title: 'V(x)' }
                }
            };
            
            Plotly.newPlot('lyapunovPlot', [trace], layout);
        }

        function visualizeStability() {
            const A = getMatrixA();
            const t = [];
            const trajectories = [];
            
            // è¤‡æ•°ã®åˆæœŸæ¡ä»¶ã‹ã‚‰è»Œé“ã‚’ç”Ÿæˆ
            const initialConditions = [
                [2, 2], [2, -2], [-2, 2], [-2, -2],
                [3, 0], [-3, 0], [0, 3], [0, -3]
            ];
            
            const dt = 0.01;
            const tMax = 5;
            const steps = Math.floor(tMax / dt);
            
            for (let t = 0; t <= tMax; t += dt) {
                // Dummy time array
            }
            
            initialConditions.forEach(x0 => {
                let x = [...x0];
                const xTraj = [x[0]];
                const yTraj = [x[1]];
                
                for (let i = 0; i < steps; i++) {
                    const dx = [
                        A[0][0] * x[0] + A[0][1] * x[1],
                        A[1][0] * x[0] + A[1][1] * x[1]
                    ];
                    x[0] += dx[0] * dt;
                    x[1] += dx[1] * dt;
                    xTraj.push(x[0]);
                    yTraj.push(x[1]);
                }
                
                trajectories.push({
                    x: xTraj,
                    y: yTraj,
                    type: 'scatter',
                    mode: 'lines',
                    line: { width: 2 },
                    name: `åˆæœŸå€¤: [${x0[0]}, ${x0[1]}]`
                });
            });
            
            const layout = {
                title: 'ä½ç›¸å¹³é¢ã§ã®è»Œé“',
                xaxis: { title: 'xâ‚', zeroline: true },
                yaxis: { title: 'xâ‚‚', zeroline: true },
                hovermode: 'closest'
            };
            
            Plotly.newPlot('phasePlot', trajectories, layout);
        }

        document.getElementById('systemType').addEventListener('change', function() {
            const type = this.value;
            if (type === 'stable2d') {
                document.getElementById('a00').value = '-1';
                document.getElementById('a01').value = '0';
                document.getElementById('a10').value = '0';
                document.getElementById('a11').value = '-2';
            } else if (type === 'unstable2d') {
                document.getElementById('a00').value = '1';
                document.getElementById('a01').value = '0';
                document.getElementById('a10').value = '0';
                document.getElementById('a11').value = '2';
            } else if (type === 'marginal') {
                document.getElementById('a00').value = '0';
                document.getElementById('a01').value = '1';
                document.getElementById('a10').value = '-1';
                document.getElementById('a11').value = '0';
            }
        });
    </script>
</body>
</html>
