<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¬¬5å›: ä¼é”é–¢æ•°ã¨çŠ¶æ…‹ç©ºé–“è¡¨ç¾</title>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; background: #f5f5f5; }
        .container { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #2c3e50; border-bottom: 3px solid #3498db; padding-bottom: 10px; }
        h2 { color: #34495e; margin-top: 30px; }
        .theory-box { background: #e8f4f8; padding: 20px; border-left: 4px solid #3498db; margin: 20px 0; border-radius: 5px; }
        .simulator { background: #f9f9f9; padding: 25px; border-radius: 8px; margin: 25px 0; border: 2px solid #ddd; }
        .controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin: 20px 0; }
        .control-group { display: flex; flex-direction: column; }
        label { font-weight: bold; color: #555; margin-bottom: 5px; }
        input, select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
        button { background: #3498db; color: white; border: none; padding: 12px 24px; border-radius: 5px; cursor: pointer; font-size: 16px; margin: 10px 5px; }
        button:hover { background: #2980b9; }
        .plot-container { margin: 20px 0; }
        .matrix-display { background: white; padding: 15px; border-radius: 5px; font-family: monospace; margin: 10px 0; border: 1px solid #ddd; }
        .example { background: #fff9e6; padding: 15px; border-left: 4px solid #f39c12; margin: 20px 0; border-radius: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“Š ç¬¬5å›: ä¼é”é–¢æ•°ã¨çŠ¶æ…‹ç©ºé–“è¡¨ç¾</h1>
        
        <div class="theory-box">
            <h2>ğŸ“š ç†è«–ã®æ¦‚è¦</h2>
            <p><strong>ä¼é”é–¢æ•°</strong>ã¯å¤å…¸åˆ¶å¾¡ç†è«–ã®åŸºæœ¬ãƒ„ãƒ¼ãƒ«ã§ã‚ã‚Šã€<strong>çŠ¶æ…‹ç©ºé–“è¡¨ç¾</strong>ã¯ç¾ä»£åˆ¶å¾¡ç†è«–ã®åŸºç¤ã§ã™ã€‚ã“ã®2ã¤ã®è¡¨ç¾æ–¹æ³•ã¯ç›¸äº’ã«å¤‰æ›å¯èƒ½ã§ã‚ã‚Šã€ãã‚Œãã‚Œç•°ãªã‚‹åˆ©ç‚¹ãŒã‚ã‚Šã¾ã™ã€‚</p>
            
            <h3>ä¼é”é–¢æ•° (Transfer Function)</h3>
            <p>ãƒ©ãƒ—ãƒ©ã‚¹å¤‰æ›ã‚’ç”¨ã„ãŸå…¥å‡ºåŠ›é–¢ä¿‚:</p>
            <p>$$G(s) = \frac{Y(s)}{U(s)} = \frac{b_m s^m + b_{m-1} s^{m-1} + \cdots + b_1 s + b_0}{s^n + a_{n-1} s^{n-1} + \cdots + a_1 s + a_0}$$</p>
            
            <h3>çŠ¶æ…‹ç©ºé–“è¡¨ç¾ (State-Space Representation)</h3>
            <p>$$\dot{x} = Ax + Bu$$</p>
            <p>$$y = Cx + Du$$</p>
            
            <h3>å¯åˆ¶å¾¡æ­£æº–å½¢å¼ (Controllable Canonical Form)</h3>
            <p>ä¼é”é–¢æ•°ã‹ã‚‰çŠ¶æ…‹ç©ºé–“è¡¨ç¾ã¸ã®æ¨™æº–çš„ãªå¤‰æ›å½¢å¼:</p>
            <p>$$A = \begin{bmatrix} 0 & 1 & 0 & \cdots & 0 \\ 0 & 0 & 1 & \cdots & 0 \\ \vdots & \vdots & \vdots & \ddots & \vdots \\ 0 & 0 & 0 & \cdots & 1 \\ -a_0 & -a_1 & -a_2 & \cdots & -a_{n-1} \end{bmatrix}, \quad B = \begin{bmatrix} 0 \\ 0 \\ \vdots \\ 0 \\ 1 \end{bmatrix}, \quad C = \begin{bmatrix} b_0 & b_1 & \cdots & b_{n-1} \end{bmatrix}$$</p>
        </div>

        <div class="simulator">
            <h2>ğŸ® ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼: ä¼é”é–¢æ•° â‡” çŠ¶æ…‹ç©ºé–“å¤‰æ›</h2>
            
            <div class="controls">
                <div class="control-group">
                    <label>ã‚·ã‚¹ãƒ†ãƒ é¸æŠ:</label>
                    <select id="systemType">
                        <option value="custom">ã‚«ã‚¹ã‚¿ãƒ å…¥åŠ›</option>
                        <option value="first">1æ¬¡ç³»: 1/(s+2)</option>
                        <option value="second">2æ¬¡ç³»: 4/(sÂ²+2s+4)</option>
                        <option value="third">3æ¬¡ç³»: 6/(sÂ³+6sÂ²+11s+6)</option>
                    </select>
                </div>
            </div>
            
            <h3>ä¼é”é–¢æ•°ã®ä¿‚æ•°å…¥åŠ›</h3>
            <div class="controls">
                <div class="control-group">
                    <label>åˆ†å­ä¿‚æ•° [bâ‚€, bâ‚, ...]:</label>
                    <input type="text" id="numCoeffs" value="4" placeholder="ä¾‹: 1, 2, 3">
                </div>
                <div class="control-group">
                    <label>åˆ†æ¯ä¿‚æ•° [aâ‚€, aâ‚, ..., aâ‚™]:</label>
                    <input type="text" id="denCoeffs" value="4, 2, 1" placeholder="ä¾‹: 1, 2, 3, 1">
                </div>
            </div>
            
            <button onclick="convertToStateSpace()">ğŸ”„ çŠ¶æ…‹ç©ºé–“è¡¨ç¾ã«å¤‰æ›</button>
            <button onclick="computeResponse()">ğŸ“ˆ ã‚¹ãƒ†ãƒƒãƒ—å¿œç­”ã‚’è¨ˆç®—</button>
            
            <div id="matrices" class="matrix-display"></div>
            <div id="poles" class="matrix-display"></div>
            <div id="stepPlot" class="plot-container"></div>
            <div id="polePlot" class="plot-container"></div>
        </div>

        <div class="example">
            <h3>ğŸ’¡ å®Ÿä¾‹: RCå›è·¯ã®è§£æ</h3>
            <p><strong>å•é¡Œ</strong>: RCå›è·¯ã®ä¼é”é–¢æ•° \( G(s) = \frac{1}{RCs + 1} \) ã‚’çŠ¶æ…‹ç©ºé–“è¡¨ç¾ã«å¤‰æ›ã›ã‚ˆã€‚</p>
            <p><strong>è§£ç­”</strong>:</p>
            <p>R = 1kÎ©, C = 1Î¼F ã®å ´åˆã€æ™‚å®šæ•° Ï„ = RC = 0.001s</p>
            <p>ä¼é”é–¢æ•°: \( G(s) = \frac{1000}{s + 1000} \)</p>
            <p>çŠ¶æ…‹ç©ºé–“è¡¨ç¾:</p>
            <p>$$\dot{x} = -1000x + 1000u$$</p>
            <p>$$y = x$$</p>
        </div>

        <div class="theory-box">
            <h2>ğŸ¯ é‡è¦ãƒã‚¤ãƒ³ãƒˆ</h2>
            <ul>
                <li>ä¼é”é–¢æ•°ã¯å‘¨æ³¢æ•°å¿œç­”è§£æã«ä¾¿åˆ©</li>
                <li>çŠ¶æ…‹ç©ºé–“è¡¨ç¾ã¯å¤šå¤‰æ•°ç³»ã‚„éç·šå½¢ç³»ã«æ‹¡å¼µå¯èƒ½</li>
                <li>å¯åˆ¶å¾¡æ­£æº–å½¢å¼ã¯åˆ¶å¾¡å™¨è¨­è¨ˆã«æœ‰ç”¨</li>
                <li>æ¥µã®ä½ç½®ã¯ä¸¡è¡¨ç¾ã§åŒä¸€ï¼ˆã‚·ã‚¹ãƒ†ãƒ ã®å›ºæœ‰ç‰¹æ€§ï¼‰</li>
                <li>çŠ¶æ…‹å¤‰æ•°ã®å–ã‚Šæ–¹ã¯ä¸€æ„ã§ã¯ãªã„ï¼ˆç›¸ä¼¼å¤‰æ›ã®è‡ªç”±åº¦ï¼‰</li>
            </ul>
        </div>
    </div>

    <script>
        function parseCoeffs(str) {
            return str.split(',').map(s => parseFloat(s.trim())).filter(n => !isNaN(n));
        }

        function convertToStateSpace() {
            const num = parseCoeffs(document.getElementById('numCoeffs').value);
            const den = parseCoeffs(document.getElementById('denCoeffs').value);
            
            if (num.length === 0 || den.length === 0) {
                alert('ä¿‚æ•°ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            const n = den.length;
            
            // å¯åˆ¶å¾¡æ­£æº–å½¢å¼ã®Aè¡Œåˆ—
            let A = Array(n).fill(0).map(() => Array(n).fill(0));
            for (let i = 0; i < n - 1; i++) {
                A[i][i + 1] = 1;
            }
            for (let i = 0; i < n; i++) {
                A[n - 1][i] = -den[i];
            }
            
            // Bè¡Œåˆ—
            let B = Array(n).fill(0);
            B[n - 1] = 1;
            
            // Cè¡Œåˆ—
            let C = Array(n).fill(0);
            for (let i = 0; i < Math.min(num.length, n); i++) {
                C[i] = num[i];
            }
            
            // Dè¡Œåˆ—
            let D = 0;
            
            displayMatrices(A, B, C, D);
            computePoles(A);
        }

        function displayMatrices(A, B, C, D) {
            const n = A.length;
            let html = '<h3>çŠ¶æ…‹ç©ºé–“è¡¨ç¾</h3>';
            
            html += '<p><strong>Aè¡Œåˆ—:</strong></p><pre>';
            for (let i = 0; i < n; i++) {
                html += '[' + A[i].map(v => v.toFixed(3).padStart(8)).join(', ') + ']\n';
            }
            html += '</pre>';
            
            html += '<p><strong>Bè¡Œåˆ—:</strong></p><pre>[' + B.map(v => v.toFixed(3)).join(', ') + ']áµ€</pre>';
            html += '<p><strong>Cè¡Œåˆ—:</strong></p><pre>[' + C.map(v => v.toFixed(3)).join(', ') + ']</pre>';
            html += '<p><strong>Dè¡Œåˆ—:</strong></p><pre>' + D + '</pre>';
            
            document.getElementById('matrices').innerHTML = html;
        }

        function computePoles(A) {
            // ç°¡æ˜“çš„ãªå›ºæœ‰å€¤è¨ˆç®—ï¼ˆ2x2ã¾ã§å¯¾å¿œï¼‰
            const n = A.length;
            let poles = [];
            
            if (n === 1) {
                poles = [{ real: A[0][0], imag: 0 }];
            } else if (n === 2) {
                const trace = A[0][0] + A[1][1];
                const det = A[0][0] * A[1][1] - A[0][1] * A[1][0];
                const discriminant = trace * trace - 4 * det;
                
                if (discriminant >= 0) {
                    poles = [
                        { real: (trace + Math.sqrt(discriminant)) / 2, imag: 0 },
                        { real: (trace - Math.sqrt(discriminant)) / 2, imag: 0 }
                    ];
                } else {
                    const realPart = trace / 2;
                    const imagPart = Math.sqrt(-discriminant) / 2;
                    poles = [
                        { real: realPart, imag: imagPart },
                        { real: realPart, imag: -imagPart }
                    ];
                }
            } else {
                document.getElementById('poles').innerHTML = '<p>3æ¬¡ä»¥ä¸Šã®ã‚·ã‚¹ãƒ†ãƒ ã®æ¥µè¨ˆç®—ã¯æ•°å€¤è§£æãŒå¿…è¦ã§ã™</p>';
                return;
            }
            
            let html = '<h3>ã‚·ã‚¹ãƒ†ãƒ ã®æ¥µï¼ˆå›ºæœ‰å€¤ï¼‰</h3>';
            poles.forEach((p, i) => {
                if (Math.abs(p.imag) < 1e-10) {
                    html += `<p>æ¥µ${i + 1}: ${p.real.toFixed(4)}</p>`;
                } else {
                    html += `<p>æ¥µ${i + 1}: ${p.real.toFixed(4)} ${p.imag >= 0 ? '+' : ''}${p.imag.toFixed(4)}j</p>`;
                }
            });
            
            document.getElementById('poles').innerHTML = html;
            plotPoles(poles);
        }

        function plotPoles(poles) {
            const realParts = poles.map(p => p.real);
            const imagParts = poles.map(p => p.imag);
            
            const trace = {
                x: realParts,
                y: imagParts,
                mode: 'markers',
                type: 'scatter',
                marker: { size: 12, color: 'red', symbol: 'x' },
                name: 'æ¥µ'
            };
            
            const layout = {
                title: 'ã‚·ã‚¹ãƒ†ãƒ ã®æ¥µã®é…ç½®',
                xaxis: { title: 'å®Ÿéƒ¨', zeroline: true, zerolinecolor: '#888' },
                yaxis: { title: 'è™šéƒ¨', zeroline: true, zerolinecolor: '#888' },
                hovermode: 'closest'
            };
            
            Plotly.newPlot('polePlot', [trace], layout);
        }

        function computeResponse() {
            // ç°¡æ˜“çš„ãªã‚¹ãƒ†ãƒƒãƒ—å¿œç­”ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
            const num = parseCoeffs(document.getElementById('numCoeffs').value);
            const den = parseCoeffs(document.getElementById('denCoeffs').value);
            
            const dt = 0.01;
            const tMax = 10;
            const steps = Math.floor(tMax / dt);
            
            let t = [];
            let y = [];
            
            // ç°¡æ˜“çš„ãªæ•°å€¤ç©åˆ†ï¼ˆ1æ¬¡ã€2æ¬¡ç³»ã®ã¿å¯¾å¿œï¼‰
            if (den.length === 2) {
                // 1æ¬¡ç³»: K/(Ï„s + 1)
                const K = num[0] / den[0];
                const tau = 1 / den[1];
                
                for (let i = 0; i <= steps; i++) {
                    const time = i * dt;
                    t.push(time);
                    y.push(K * (1 - Math.exp(-time / tau)));
                }
            } else if (den.length === 3) {
                // 2æ¬¡ç³»
                const K = num[0] / den[0];
                const wn = Math.sqrt(den[0]);
                const zeta = den[1] / (2 * wn);
                
                if (zeta < 1) {
                    const wd = wn * Math.sqrt(1 - zeta * zeta);
                    for (let i = 0; i <= steps; i++) {
                        const time = i * dt;
                        t.push(time);
                        const envelope = Math.exp(-zeta * wn * time);
                        y.push(K * (1 - envelope * (Math.cos(wd * time) + (zeta / Math.sqrt(1 - zeta * zeta)) * Math.sin(wd * time))));
                    }
                } else {
                    for (let i = 0; i <= steps; i++) {
                        const time = i * dt;
                        t.push(time);
                        y.push(K * (1 - Math.exp(-wn * time) * (1 + wn * time)));
                    }
                }
            } else {
                alert('ã“ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã¯1æ¬¡ãŠã‚ˆã³2æ¬¡ç³»ã®ã¿ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™');
                return;
            }
            
            const trace = {
                x: t,
                y: y,
                type: 'scatter',
                mode: 'lines',
                name: 'ã‚¹ãƒ†ãƒƒãƒ—å¿œç­”',
                line: { color: '#3498db', width: 2 }
            };
            
            const layout = {
                title: 'ã‚¹ãƒ†ãƒƒãƒ—å¿œç­”',
                xaxis: { title: 'æ™‚é–“ [s]' },
                yaxis: { title: 'å‡ºåŠ›' },
                hovermode: 'x'
            };
            
            Plotly.newPlot('stepPlot', [trace], layout);
        }

        document.getElementById('systemType').addEventListener('change', function() {
            const type = this.value;
            if (type === 'first') {
                document.getElementById('numCoeffs').value = '1';
                document.getElementById('denCoeffs').value = '1, 2';
            } else if (type === 'second') {
                document.getElementById('numCoeffs').value = '4';
                document.getElementById('denCoeffs').value = '4, 2, 1';
            } else if (type === 'third') {
                document.getElementById('numCoeffs').value = '6';
                document.getElementById('denCoeffs').value = '6, 11, 6, 1';
            }
        });
    </script>
</body>
</html>
