<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¬¬13å›: ãƒªãƒƒã‚«ãƒæ–¹ç¨‹å¼ã¨æœ€é©æ€§</title>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; background: #f5f5f5; }
        .container { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #2c3e50; border-bottom: 3px solid #d35400; padding-bottom: 10px; }
        h2 { color: #34495e; margin-top: 30px; }
        .theory-box { background: #fef5e7; padding: 20px; border-left: 4px solid #d35400; margin: 20px 0; border-radius: 5px; }
        .simulator { background: #f9f9f9; padding: 25px; border-radius: 8px; margin: 25px 0; border: 2px solid #ddd; }
        .controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin: 20px 0; }
        .control-group { display: flex; flex-direction: column; }
        label { font-weight: bold; color: #555; margin-bottom: 5px; }
        input, select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
        button { background: #d35400; color: white; border: none; padding: 12px 24px; border-radius: 5px; cursor: pointer; font-size: 16px; margin: 10px 5px; }
        button:hover { background: #ba4a00; }
        .plot-container { margin: 20px 0; }
        .matrix-display { background: white; padding: 15px; border-radius: 5px; font-family: monospace; margin: 10px 0; border: 1px solid #ddd; white-space: pre-wrap; }
        .example { background: #e8f8f5; padding: 15px; border-left: 4px solid #1abc9c; margin: 20px 0; border-radius: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¯ ç¬¬13å›: ãƒªãƒƒã‚«ãƒæ–¹ç¨‹å¼ã¨æœ€é©æ€§</h1>
        
        <div class="theory-box">
            <h2>ğŸ“š ç†è«–ã®æ¦‚è¦</h2>
            <p><strong>ãƒªãƒƒã‚«ãƒæ–¹ç¨‹å¼ï¼ˆRiccati Equationï¼‰</strong>ã¯ã€LQRï¼ˆç·šå½¢äºŒæ¬¡ãƒ¬ã‚®ãƒ¥ãƒ¬ãƒ¼ã‚¿ï¼‰å•é¡Œã‚’è§£ããŸã‚ã®æ ¸å¿ƒã¨ãªã‚‹æ–¹ç¨‹å¼ã§ã™ã€‚æœ€é©åˆ¶å¾¡ç†è«–ã®åŸºç¤ã‚’ãªã—ã¾ã™ã€‚</p>
            
            <h3>ä»£æ•°ãƒªãƒƒã‚«ãƒæ–¹ç¨‹å¼ (ARE)</h3>
            <p>LQRå•é¡Œã®è§£ \( P \) ã¯ä»¥ä¸‹ã®æ–¹ç¨‹å¼ã‚’æº€ãŸã—ã¾ã™:</p>
            <p>$$A^T P + PA - PBR^{-1}B^T P + Q = 0$$</p>
            
            <h3>æœ€é©ã‚²ã‚¤ãƒ³</h3>
            <p>ã“ã® \( P \) ã‹ã‚‰æœ€é©ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚²ã‚¤ãƒ³ãŒè¨ˆç®—ã•ã‚Œã¾ã™:</p>
            <p>$$K = R^{-1}B^T P$$</p>
            
            <h3>æœ€å°ã‚³ã‚¹ãƒˆ</h3>
            <p>åˆæœŸçŠ¶æ…‹ \( x_0 \) ã‹ã‚‰ã®æœ€å°ã‚³ã‚¹ãƒˆ:</p>
            <p>$$J^* = x_0^T P x_0$$</p>
            
            <h3>ãƒãƒŸãƒ«ãƒˆãƒ‹ã‚¢ãƒ³ã¨å›ºæœ‰å€¤</h3>
            <p>ãƒãƒŸãƒ«ãƒˆãƒ‹ã‚¢ãƒ³è¡Œåˆ— \( H \) ã®å®‰å®šå›ºæœ‰å€¤ã«å¯¾å¿œã™ã‚‹å›ºæœ‰ãƒ™ã‚¯ãƒˆãƒ«ã‹ã‚‰ \( P \) ã‚’æ§‹æˆã§ãã¾ã™:</p>
            <p>$$H = \begin{bmatrix} A & -BR^{-1}B^T \\ -Q & -A^T \end{bmatrix}$$</p>
        </div>

        <div class="simulator">
            <h2>ğŸ® ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼: ãƒªãƒƒã‚«ãƒæ–¹ç¨‹å¼æ±‚è§£å™¨</h2>
            
            <div class="controls">
                <div class="control-group">
                    <label>ã‚·ã‚¹ãƒ†ãƒ é¸æŠ:</label>
                    <select id="systemType">
                        <option value="custom">ã‚«ã‚¹ã‚¿ãƒ å…¥åŠ›</option>
                        <option value="integrator">ç©åˆ†å™¨</option>
                        <option value="oscillator">èª¿å’ŒæŒ¯å‹•å­</option>
                    </select>
                </div>
            </div>
            
            <h3>ã‚·ã‚¹ãƒ†ãƒ è¡Œåˆ—å…¥åŠ›ï¼ˆ2Ã—2ï¼‰</h3>
            <div class="controls">
                <div class="control-group">
                    <label>A[0,0]:</label>
                    <input type="number" id="a00" value="0" step="0.1">
                </div>
                <div class="control-group">
                    <label>A[0,1]:</label>
                    <input type="number" id="a01" value="1" step="0.1">
                </div>
                <div class="control-group">
                    <label>A[1,0]:</label>
                    <input type="number" id="a10" value="0" step="0.1">
                </div>
                <div class="control-group">
                    <label>A[1,1]:</label>
                    <input type="number" id="a11" value="0" step="0.1">
                </div>
            </div>
            
            <div class="controls">
                <div class="control-group">
                    <label>B[0]:</label>
                    <input type="number" id="b0" value="0" step="0.1">
                </div>
                <div class="control-group">
                    <label>B[1]:</label>
                    <input type="number" id="b1" value="1" step="0.1">
                </div>
            </div>
            
            <h3>é‡ã¿è¡Œåˆ—</h3>
            <div class="controls">
                <div class="control-group">
                    <label>Q[0,0] (çŠ¶æ…‹é‡ã¿):</label>
                    <input type="number" id="q00" value="1" step="0.1">
                </div>
                <div class="control-group">
                    <label>Q[1,1] (çŠ¶æ…‹é‡ã¿):</label>
                    <input type="number" id="q11" value="1" step="0.1">
                </div>
                <div class="control-group">
                    <label>R (å…¥åŠ›é‡ã¿):</label>
                    <input type="number" id="r" value="1" step="0.1">
                </div>
            </div>
            
            <button onclick="solveRiccati()">ğŸ§® ãƒªãƒƒã‚«ãƒæ–¹ç¨‹å¼ã‚’è§£ã</button>
            <button onclick="visualizeOptimality()">ğŸ“Š æœ€é©æ€§ã‚’å¯è¦–åŒ–</button>
            
            <div id="matrixP" class="matrix-display"></div>
            <div id="gainK" class="matrix-display"></div>
            <div id="closedLoopPoles" class="matrix-display"></div>
            <div id="costPlot" class="plot-container"></div>
        </div>

        <div class="example">
            <h3>ğŸ’¡ å®Ÿä¾‹: å€’ç«‹æŒ¯å­ã®æœ€é©åˆ¶å¾¡</h3>
            <p><strong>å•é¡Œ</strong>: å€’ç«‹æŒ¯å­ã‚’æœ€å°ã‚¨ãƒãƒ«ã‚®ãƒ¼ã§å®‰å®šåŒ–ã™ã‚‹LQRã‚²ã‚¤ãƒ³ã‚’æ±‚ã‚ã‚ˆã€‚</p>
            <p><strong>è§£ç­”</strong>:</p>
            <p>ã‚·ã‚¹ãƒ†ãƒ : \( A = \begin{bmatrix} 0 & 1 \\ 20 & 0 \end{bmatrix}, B = \begin{bmatrix} 0 \\ 1 \end{bmatrix} \)</p>
            <p>é‡ã¿: \( Q = \begin{bmatrix} 10 & 0 \\ 0 & 1 \end{bmatrix}, R = 1 \)</p>
            <p>ãƒªãƒƒã‚«ãƒæ–¹ç¨‹å¼ã‚’è§£ãã¨:</p>
            <p>$$P = \begin{bmatrix} 4.79 & 0.45 \\ 0.45 & 0.27 \end{bmatrix}$$</p>
            <p>æœ€é©ã‚²ã‚¤ãƒ³: \( K = [0.45, 0.27] \)</p>
        </div>

        <div class="theory-box">
            <h2>ğŸ¯ é‡è¦ãƒã‚¤ãƒ³ãƒˆ</h2>
            <ul>
                <li>ãƒªãƒƒã‚«ãƒæ–¹ç¨‹å¼ã¯éç·šå½¢ã ãŒã€è§£ã¯ä¸€æ„ï¼ˆå®‰å®šåŒ–è§£ï¼‰</li>
                <li>ãƒãƒŸãƒ«ãƒˆãƒ‹ã‚¢ãƒ³ã®å›ºæœ‰å€¤æ§‹é€ ã‹ã‚‰è§£ã‚’æ§‹æˆå¯èƒ½</li>
                <li>LQRåˆ¶å¾¡ã¯å®‰å®šä½™è£•ãŒä¿è¨¼ã•ã‚Œã‚‹ï¼ˆã‚²ã‚¤ãƒ³ä½™è£•âˆã€ä½ç›¸ä½™è£•â‰§60Â°ï¼‰</li>
                <li>é‡ã¿è¡Œåˆ— Q, R ã®èª¿æ•´ã§åˆ¶å¾¡æ€§èƒ½ã‚’è¨­è¨ˆ</li>
                <li>å®Ÿè£…ã«ã¯æ•°å€¤è¨ˆç®—ãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼ˆMATLAB, Python Controlï¼‰ã‚’ä½¿ç”¨</li>
            </ul>
        </div>
    </div>

    <script>
        function getSystem() {
            const A = [
                [parseFloat(document.getElementById('a00').value), parseFloat(document.getElementById('a01').value)],
                [parseFloat(document.getElementById('a10').value), parseFloat(document.getElementById('a11').value)]
            ];
            const B = [parseFloat(document.getElementById('b0').value), parseFloat(document.getElementById('b1').value)];
            const Q = [
                [parseFloat(document.getElementById('q00').value), 0],
                [0, parseFloat(document.getElementById('q11').value)]
            ];
            const R = parseFloat(document.getElementById('r').value);
            return { A, B, Q, R };
        }

        function solveRiccati() {
            const { A, B, Q, R } = getSystem();
            
            // 2Ã—2ã‚·ã‚¹ãƒ†ãƒ ã®å ´åˆã€ãƒªãƒƒã‚«ãƒæ–¹ç¨‹å¼ã‚’ç›´æ¥è§£ã
            // P = [p11, p12; p12, p22] ã¨ã—ã¦é€£ç«‹æ–¹ç¨‹å¼ã‚’è§£ã
            
            // A^T P + P A - P B R^{-1} B^T P + Q = 0
            const a = A[0][0], b = A[0][1], c = A[1][0], d = A[1][1];
            const b1 = B[0], b2 = B[1];
            const q1 = Q[0][0], q2 = Q[1][1];
            
            // éç·šå½¢æ–¹ç¨‹å¼ç³»ã‚’åå¾©æ³•ã§è§£ãï¼ˆç°¡æ˜“çš„ãªãƒ‹ãƒ¥ãƒ¼ãƒˆãƒ³æ³•ï¼‰
            let P = [[q1, 0], [0, q2]]; // åˆæœŸæ¨å®šå€¤
            
            for (let iter = 0; iter < 100; iter++) {
                const p11 = P[0][0], p12 = P[0][1], p22 = P[1][1];
                
                // BR^{-1}B^T P ã®è¨ˆç®—
                const BR_inv = [b1 / R, b2 / R];
                const BR_inv_BT_P = [
                    [BR_inv[0] * (b1 * p11 + b2 * p12), BR_inv[0] * (b1 * p12 + b2 * p22)],
                    [BR_inv[1] * (b1 * p11 + b2 * p12), BR_inv[1] * (b1 * p12 + b2 * p22)]
                ];
                
                // æ®‹å·®ã®è¨ˆç®—: A^T P + P A - P BR^{-1}B^T P + Q
                const residual = [
                    [
                        a * p11 + c * p12 + p11 * a + p12 * c - BR_inv_BT_P[0][0] + q1,
                        a * p12 + c * p22 + p11 * b + p12 * d - BR_inv_BT_P[0][1]
                    ],
                    [
                        b * p11 + d * p12 + p12 * a + p22 * c - BR_inv_BT_P[1][0],
                        b * p12 + d * p22 + p12 * b + p22 * d - BR_inv_BT_P[1][1] + q2
                    ]
                ];
                
                // åæŸåˆ¤å®š
                const norm = Math.sqrt(
                    residual[0][0] ** 2 + residual[0][1] ** 2 + 
                    residual[1][0] ** 2 + residual[1][1] ** 2
                );
                
                if (norm < 1e-8) break;
                
                // ç°¡æ˜“çš„ãªæ›´æ–°ï¼ˆå‹¾é…é™ä¸‹çš„æ‰‹æ³•ï¼‰
                const alpha = 0.1;
                P[0][0] -= alpha * residual[0][0];
                P[0][1] -= alpha * residual[0][1];
                P[1][0] = P[0][1]; // å¯¾ç§°æ€§
                P[1][1] -= alpha * residual[1][1];
                
                // æ­£å®šæ€§ã®ç¢ºä¿
                if (P[0][0] < 0.01) P[0][0] = 0.01;
                if (P[1][1] < 0.01) P[1][1] = 0.01;
            }
            
            // çµæœè¡¨ç¤º
            let html = '<h3>ãƒªãƒƒã‚«ãƒæ–¹ç¨‹å¼ã®è§£ P</h3>';
            html += `<pre>[${P[0][0].toFixed(4)}, ${P[0][1].toFixed(4)}]\n[${P[1][0].toFixed(4)}, ${P[1][1].toFixed(4)}]</pre>`;
            document.getElementById('matrixP').innerHTML = html;
            
            // æœ€é©ã‚²ã‚¤ãƒ³ã®è¨ˆç®—: K = R^{-1} B^T P
            const K = [
                (B[0] * P[0][0] + B[1] * P[1][0]) / R,
                (B[0] * P[0][1] + B[1] * P[1][1]) / R
            ];
            
            html = '<h3>æœ€é©ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚²ã‚¤ãƒ³ K</h3>';
            html += `<pre>[${K[0].toFixed(4)}, ${K[1].toFixed(4)}]</pre>`;
            html += '<p>åˆ¶å¾¡å‰‡: u = -K x</p>';
            document.getElementById('gainK').innerHTML = html;
            
            // é–‰ãƒ«ãƒ¼ãƒ—ç³»ã®æ¥µ: A - BK
            const A_BK = [
                [A[0][0] - B[0] * K[0], A[0][1] - B[0] * K[1]],
                [A[1][0] - B[1] * K[0], A[1][1] - B[1] * K[1]]
            ];
            
            const tr = A_BK[0][0] + A_BK[1][1];
            const det = A_BK[0][0] * A_BK[1][1] - A_BK[0][1] * A_BK[1][0];
            const disc = tr * tr - 4 * det;
            
            html = '<h3>é–‰ãƒ«ãƒ¼ãƒ—ç³»ã®æ¥µ</h3>';
            if (disc >= 0) {
                const ev1 = (tr + Math.sqrt(disc)) / 2;
                const ev2 = (tr - Math.sqrt(disc)) / 2;
                html += `<pre>æ¥µ1: ${ev1.toFixed(4)}\næ¥µ2: ${ev2.toFixed(4)}</pre>`;
            } else {
                const real = tr / 2;
                const imag = Math.sqrt(-disc) / 2;
                html += `<pre>æ¥µ1: ${real.toFixed(4)} + ${imag.toFixed(4)}j\næ¥µ2: ${real.toFixed(4)} - ${imag.toFixed(4)}j</pre>`;
            }
            document.getElementById('closedLoopPoles').innerHTML = html;
            
            // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ä¿å­˜
            window.riccatiP = P;
            window.optimalK = K;
        }

        function visualizeOptimality() {
            const { A, B, Q, R } = getSystem();
            const P = window.riccatiP;
            const K = window.optimalK;
            
            if (!P || !K) {
                alert('å…ˆã«ãƒªãƒƒã‚«ãƒæ–¹ç¨‹å¼ã‚’è§£ã„ã¦ãã ã•ã„');
                return;
            }
            
            // åˆæœŸçŠ¶æ…‹ã®ã‚°ãƒªãƒƒãƒ‰ã§ã‚³ã‚¹ãƒˆã‚’è¨ˆç®—
            const x1_range = [];
            const x2_range = [];
            const cost = [];
            
            const range = 5;
            const steps = 30;
            
            for (let i = 0; i <= steps; i++) {
                const x1 = -range + (2 * range * i / steps);
                const row1 = [], row2 = [], rowCost = [];
                for (let j = 0; j <= steps; j++) {
                    const x2 = -range + (2 * range * j / steps);
                    const J = P[0][0] * x1 * x1 + 2 * P[0][1] * x1 * x2 + P[1][1] * x2 * x2;
                    row1.push(x1);
                    row2.push(x2);
                    rowCost.push(J);
                }
                x1_range.push(row1);
                x2_range.push(row2);
                cost.push(rowCost);
            }
            
            const trace = {
                x: x1_range,
                y: x2_range,
                z: cost,
                type: 'surface',
                colorscale: 'Viridis',
                name: 'J*(x)'
            };
            
            const layout = {
                title: 'æœ€é©ã‚³ã‚¹ãƒˆé–¢æ•° J*(x) = x^T P x',
                scene: {
                    xaxis: { title: 'xâ‚' },
                    yaxis: { title: 'xâ‚‚' },
                    zaxis: { title: 'ã‚³ã‚¹ãƒˆ J*' }
                }
            };
            
            Plotly.newPlot('costPlot', [trace], layout);
        }

        document.getElementById('systemType').addEventListener('change', function() {
            const type = this.value;
            if (type === 'integrator') {
                document.getElementById('a00').value = '0';
                document.getElementById('a01').value = '1';
                document.getElementById('a10').value = '0';
                document.getElementById('a11').value = '0';
                document.getElementById('b0').value = '0';
                document.getElementById('b1').value = '1';
            } else if (type === 'oscillator') {
                document.getElementById('a00').value = '0';
                document.getElementById('a01').value = '1';
                document.getElementById('a10').value = '-4';
                document.getElementById('a11').value = '0';
                document.getElementById('b0').value = '0';
                document.getElementById('b1').value = '1';
            }
        });
    </script>
</body>
</html>
