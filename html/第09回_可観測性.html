<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¬¬9å›: å¯è¦³æ¸¬æ€§</title>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; background: #f5f5f5; }
        .container { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #2c3e50; border-bottom: 3px solid #9b59b6; padding-bottom: 10px; }
        h2 { color: #34495e; margin-top: 30px; }
        .theory-box { background: #f4ecf7; padding: 20px; border-left: 4px solid #9b59b6; margin: 20px 0; border-radius: 5px; }
        .simulator { background: #f9f9f9; padding: 25px; border-radius: 8px; margin: 25px 0; border: 2px solid #ddd; }
        .controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin: 20px 0; }
        .control-group { display: flex; flex-direction: column; }
        label { font-weight: bold; color: #555; margin-bottom: 5px; }
        input, select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
        button { background: #9b59b6; color: white; border: none; padding: 12px 24px; border-radius: 5px; cursor: pointer; font-size: 16px; margin: 10px 5px; }
        button:hover { background: #8e44ad; }
        .plot-container { margin: 20px 0; }
        .matrix-display { background: white; padding: 15px; border-radius: 5px; font-family: monospace; margin: 10px 0; border: 1px solid #ddd; white-space: pre-wrap; }
        .example { background: #e8f8f5; padding: 15px; border-left: 4px solid #1abc9c; margin: 20px 0; border-radius: 5px; }
        .result-box { padding: 15px; border-radius: 5px; margin: 15px 0; font-weight: bold; text-align: center; }
        .observable { background: #d4edda; color: #155724; border: 2px solid #c3e6cb; }
        .not-observable { background: #f8d7da; color: #721c24; border: 2px solid #f5c6cb; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” ç¬¬9å›: å¯è¦³æ¸¬æ€§</h1>
        
        <div class="theory-box">
            <h2>ğŸ“š ç†è«–ã®æ¦‚è¦</h2>
            <p><strong>å¯è¦³æ¸¬æ€§ï¼ˆObservabilityï¼‰</strong>ã¯ã€ã‚·ã‚¹ãƒ†ãƒ ã®å†…éƒ¨çŠ¶æ…‹ã‚’å‡ºåŠ›æ¸¬å®šã‹ã‚‰æ¨å®šã§ãã‚‹ã‹ã©ã†ã‹ã‚’åˆ¤å®šã™ã‚‹æ¦‚å¿µã§ã™ã€‚å¯åˆ¶å¾¡æ€§ã¨åŒå¯¾ã®é–¢ä¿‚ã«ã‚ã‚Šã¾ã™ã€‚</p>
            
            <h3>å¯è¦³æ¸¬æ€§ã®å®šç¾©</h3>
            <p>ã‚·ã‚¹ãƒ†ãƒ  \( \dot{x} = Ax + Bu, \; y = Cx + Du \) ã«ãŠã„ã¦ã€æœ‰é™æ™‚é–“å†…ã®å‡ºåŠ› \( y(t) \) ãŠã‚ˆã³å…¥åŠ› \( u(t) \) ã®æƒ…å ±ã‹ã‚‰åˆæœŸçŠ¶æ…‹ \( x(0) \) ã‚’ä¸€æ„ã«æ±ºå®šã§ãã‚‹ã¨ãã€ã‚·ã‚¹ãƒ†ãƒ ã¯<strong>å¯è¦³æ¸¬</strong>ã§ã‚ã‚‹ã¨ã„ã†ã€‚</p>
            
            <h3>å¯è¦³æ¸¬æ€§è¡Œåˆ—</h3>
            <p>næ¬¡å…ƒã‚·ã‚¹ãƒ†ãƒ ã®å¯è¦³æ¸¬æ€§è¡Œåˆ— \( \mathcal{O} \) ã¯:</p>
            <p>$$\mathcal{O} = \begin{bmatrix} C \\ CA \\ CA^2 \\ \vdots \\ CA^{n-1} \end{bmatrix}$$</p>
            
            <h3>å¯è¦³æ¸¬æ€§åˆ¤å®šæ¡ä»¶</h3>
            <p>ã‚·ã‚¹ãƒ†ãƒ ãŒå¯è¦³æ¸¬ã§ã‚ã‚‹ âŸº \( \text{rank}(\mathcal{O}) = n \)</p>
            
            <h3>ç‰©ç†çš„è§£é‡ˆ</h3>
            <ul>
                <li><strong>å¯è¦³æ¸¬</strong>: ã™ã¹ã¦ã®çŠ¶æ…‹å¤‰æ•°ãŒã‚»ãƒ³ã‚µãƒ¼å‡ºåŠ›ã«å½±éŸ¿ã‚’ä¸ãˆã‚‹</li>
                <li><strong>ä¸å¯è¦³æ¸¬</strong>: ä¸€éƒ¨ã®çŠ¶æ…‹ãŒã€Œéš ã‚Œã¦ã€ãŠã‚Šã€æ¸¬å®šã§ããªã„</li>
            </ul>
            
            <h3>å¯åˆ¶å¾¡æ€§ã¨ã®åŒå¯¾æ€§</h3>
            <p>ã‚·ã‚¹ãƒ†ãƒ  \( (A, B, C) \) ãŒå¯è¦³æ¸¬ âŸº ã‚·ã‚¹ãƒ†ãƒ  \( (A^T, C^T, B^T) \) ãŒå¯åˆ¶å¾¡</p>
        </div>

        <div class="simulator">
            <h2>ğŸ® ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼: å¯è¦³æ¸¬æ€§åˆ¤å®š</h2>
            
            <div class="controls">
                <div class="control-group">
                    <label>ã‚·ã‚¹ãƒ†ãƒ é¸æŠ:</label>
                    <select id="systemType">
                        <option value="custom">ã‚«ã‚¹ã‚¿ãƒ å…¥åŠ›</option>
                        <option value="observable">å¯è¦³æ¸¬ãª2æ¬¡ç³»</option>
                        <option value="unobservable">ä¸å¯è¦³æ¸¬ãª2æ¬¡ç³»</option>
                        <option value="partial">éƒ¨åˆ†çš„ã«å¯è¦³æ¸¬ãªç³»</option>
                    </select>
                </div>
            </div>
            
            <h3>ã‚·ã‚¹ãƒ†ãƒ è¡Œåˆ— A ã¨ C ã®å…¥åŠ›ï¼ˆ2Ã—2 ã‚·ã‚¹ãƒ†ãƒ ï¼‰</h3>
            <div class="controls">
                <div class="control-group">
                    <label>A[0,0]:</label>
                    <input type="number" id="a00" value="-1" step="0.1">
                </div>
                <div class="control-group">
                    <label>A[0,1]:</label>
                    <input type="number" id="a01" value="1" step="0.1">
                </div>
                <div class="control-group">
                    <label>A[1,0]:</label>
                    <input type="number" id="a10" value="0" step="0.1">
                </div>
                <div class="control-group">
                    <label>A[1,1]:</label>
                    <input type="number" id="a11" value="-2" step="0.1">
                </div>
            </div>
            
            <div class="controls">
                <div class="control-group">
                    <label>C[0]:</label>
                    <input type="number" id="c0" value="1" step="0.1">
                </div>
                <div class="control-group">
                    <label>C[1]:</label>
                    <input type="number" id="c1" value="0" step="0.1">
                </div>
            </div>
            
            <button onclick="checkObservability()">ğŸ” å¯è¦³æ¸¬æ€§ã‚’åˆ¤å®š</button>
            <button onclick="simulateStateEstimation()">ğŸ“ˆ çŠ¶æ…‹æ¨å®šã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ</button>
            
            <div id="observabilityResult"></div>
            <div id="obsMatrix" class="matrix-display"></div>
            <div id="rankInfo" class="matrix-display"></div>
            <div id="estimationPlot" class="plot-container"></div>
        </div>

        <div class="example">
            <h3>ğŸ’¡ å®Ÿä¾‹: ä½ç½®ã®ã¿æ¸¬å®šå¯èƒ½ãªè³ªç‚¹ç³»</h3>
            <p><strong>å•é¡Œ</strong>: è³ªç‚¹ã®é‹å‹•æ–¹ç¨‹å¼ \( m\ddot{x} = u \) ã«ãŠã„ã¦ã€ä½ç½® \( x \) ã®ã¿ãŒæ¸¬å®šã§ãã‚‹å ´åˆã€ã‚·ã‚¹ãƒ†ãƒ ã¯å¯è¦³æ¸¬ã‹?</p>
            <p><strong>è§£ç­”</strong>:</p>
            <p>çŠ¶æ…‹å¤‰æ•° \( [x, \dot{x}]^T \) ã¨ã—ã¦çŠ¶æ…‹æ–¹ç¨‹å¼:</p>
            <p>$$\begin{bmatrix} \dot{x} \\ \ddot{x} \end{bmatrix} = \begin{bmatrix} 0 & 1 \\ 0 & 0 \end{bmatrix} \begin{bmatrix} x \\ \dot{x} \end{bmatrix} + \begin{bmatrix} 0 \\ 1/m \end{bmatrix} u, \quad y = \begin{bmatrix} 1 & 0 \end{bmatrix} \begin{bmatrix} x \\ \dot{x} \end{bmatrix}$$</p>
            <p>å¯è¦³æ¸¬æ€§è¡Œåˆ—:</p>
            <p>$$\mathcal{O} = \begin{bmatrix} C \\ CA \end{bmatrix} = \begin{bmatrix} 1 & 0 \\ 0 & 1 \end{bmatrix}$$</p>
            <p>\( \text{rank}(\mathcal{O}) = 2 = n \) â†’ <strong>å¯è¦³æ¸¬</strong></p>
            <p>ä½ç½®ã®æ™‚é–“å¤‰åŒ–ã‹ã‚‰é€Ÿåº¦ã‚’æ¨å®šã§ãã‚‹ï¼</p>
        </div>

        <div class="theory-box">
            <h2>ğŸ¯ é‡è¦ãƒã‚¤ãƒ³ãƒˆ</h2>
            <ul>
                <li>å¯è¦³æ¸¬æ€§ã¯çŠ¶æ…‹æ¨å®šï¼ˆã‚ªãƒ–ã‚¶ãƒ¼ãƒè¨­è¨ˆï¼‰ã®å‰ææ¡ä»¶</li>
                <li>ä¸å¯è¦³æ¸¬ãªçŠ¶æ…‹ã¯æ¨å®šä¸å¯èƒ½ï¼ˆã‚»ãƒ³ã‚µãƒ¼è¿½åŠ ãŒå¿…è¦ï¼‰</li>
                <li>å¯åˆ¶å¾¡æ€§ã¨å¯è¦³æ¸¬æ€§ã¯ç‹¬ç«‹ãªæ€§è³ªï¼ˆä¸¡æ–¹æº€ãŸã™ã¨ã¯é™ã‚‰ãªã„ï¼‰</li>
                <li>ç·šå½¢ã‚·ã‚¹ãƒ†ãƒ ã§ã¯ä»£æ•°çš„æ¡ä»¶ã§åˆ¤å®šå¯èƒ½</li>
                <li>å®Ÿéš›ã®ã‚·ã‚¹ãƒ†ãƒ ã§ã¯æ¸¬å®šãƒã‚¤ã‚ºã‚„æ•°å€¤èª¤å·®ã‚‚è€ƒæ…®ãŒå¿…è¦</li>
            </ul>
        </div>
    </div>

    <script>
        function getSystem() {
            const A = [
                [parseFloat(document.getElementById('a00').value), parseFloat(document.getElementById('a01').value)],
                [parseFloat(document.getElementById('a10').value), parseFloat(document.getElementById('a11').value)]
            ];
            const C = [parseFloat(document.getElementById('c0').value), parseFloat(document.getElementById('c1').value)];
            return { A, C };
        }

        function checkObservability() {
            const { A, C } = getSystem();
            
            // å¯è¦³æ¸¬æ€§è¡Œåˆ— O = [C; CA]
            const CA = [
                C[0] * A[0][0] + C[1] * A[1][0],
                C[0] * A[0][1] + C[1] * A[1][1]
            ];
            
            const O = [C, CA];
            
            // ãƒ©ãƒ³ã‚¯è¨ˆç®—ï¼ˆ2Ã—2ã®å ´åˆï¼‰
            const det = O[0][0] * O[1][1] - O[0][1] * O[1][0];
            const rank = Math.abs(det) > 1e-10 ? 2 : (Math.abs(O[0][0]) > 1e-10 || Math.abs(O[0][1]) > 1e-10 || Math.abs(O[1][0]) > 1e-10 || Math.abs(O[1][1]) > 1e-10 ? 1 : 0);
            
            const isObservable = (rank === 2);
            
            // çµæœè¡¨ç¤º
            let html = '<div class="result-box ' + (isObservable ? 'observable' : 'not-observable') + '">';
            html += isObservable ? 'âœ… ã‚·ã‚¹ãƒ†ãƒ ã¯å¯è¦³æ¸¬ã§ã™' : 'âŒ ã‚·ã‚¹ãƒ†ãƒ ã¯ä¸å¯è¦³æ¸¬ã§ã™';
            html += '</div>';
            document.getElementById('observabilityResult').innerHTML = html;
            
            html = '<h3>å¯è¦³æ¸¬æ€§è¡Œåˆ— O</h3>';
            html += `<pre>[${O[0][0].toFixed(4)}, ${O[0][1].toFixed(4)}]  â† C\n[${O[1][0].toFixed(4)}, ${O[1][1].toFixed(4)}]  â† CA</pre>`;
            document.getElementById('obsMatrix').innerHTML = html;
            
            html = '<h3>ãƒ©ãƒ³ã‚¯æƒ…å ±</h3>';
            html += `<pre>rank(O) = ${rank}\n`;
            html += `è¡Œåˆ—å¼ = ${det.toFixed(6)}\n`;
            html += `ã‚·ã‚¹ãƒ†ãƒ æ¬¡å…ƒ n = 2\n\n`;
            html += isObservable ? 'å¯è¦³æ¸¬æ¡ä»¶ rank(O) = n ã‚’æº€ãŸã™' : 'å¯è¦³æ¸¬æ¡ä»¶ rank(O) = n ã‚’æº€ãŸã•ãªã„';
            html += '</pre>';
            document.getElementById('rankInfo').innerHTML = html;
        }

        function simulateStateEstimation() {
            const { A, C } = getSystem();
            
            // çœŸã®çŠ¶æ…‹ã®æ™‚é–“ç™ºå±•ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
            const dt = 0.01;
            const tMax = 5;
            const steps = Math.floor(tMax / dt);
            
            let x_true = [2, 1]; // çœŸã®åˆæœŸçŠ¶æ…‹
            let x_obs = [0, 0];   // è¦³æ¸¬ã‹ã‚‰æ¨å®šã•ã‚Œã‚‹çŠ¶æ…‹ï¼ˆç°¡æ˜“çš„ãªã‚ªãƒ–ã‚¶ãƒ¼ãƒï¼‰
            
            const t = [];
            const x1_true = [x_true[0]];
            const x2_true = [x_true[1]];
            const x1_obs = [x_obs[0]];
            const x2_obs = [x_obs[1]];
            const y_measured = [C[0] * x_true[0] + C[1] * x_true[1]];
            
            // ç°¡æ˜“çš„ãªã‚ªãƒ–ã‚¶ãƒ¼ãƒã‚²ã‚¤ãƒ³ï¼ˆå®Ÿéš›ã¯ãƒ«ãƒ¼ã‚¨ãƒ³ãƒãƒ¼ã‚¬ãƒ¼ã‚ªãƒ–ã‚¶ãƒ¼ãƒç­‰ã‚’ä½¿ç”¨ï¼‰
            const L = [2, 1.5];
            
            for (let i = 0; i < steps; i++) {
                t.push(i * dt);
                
                // çœŸã®çŠ¶æ…‹ã®æ›´æ–°
                const dx_true = [
                    A[0][0] * x_true[0] + A[0][1] * x_true[1],
                    A[1][0] * x_true[0] + A[1][1] * x_true[1]
                ];
                x_true[0] += dx_true[0] * dt;
                x_true[1] += dx_true[1] * dt;
                
                // æ¸¬å®šå€¤
                const y = C[0] * x_true[0] + C[1] * x_true[1];
                
                // æ¨å®šå€¤ã®æ›´æ–°ï¼ˆç°¡æ˜“ã‚ªãƒ–ã‚¶ãƒ¼ãƒï¼‰
                const y_est = C[0] * x_obs[0] + C[1] * x_obs[1];
                const error = y - y_est;
                
                const dx_obs = [
                    A[0][0] * x_obs[0] + A[0][1] * x_obs[1] + L[0] * error,
                    A[1][0] * x_obs[0] + A[1][1] * x_obs[1] + L[1] * error
                ];
                x_obs[0] += dx_obs[0] * dt;
                x_obs[1] += dx_obs[1] * dt;
                
                x1_true.push(x_true[0]);
                x2_true.push(x_true[1]);
                x1_obs.push(x_obs[0]);
                x2_obs.push(x_obs[1]);
                y_measured.push(y);
            }
            
            const traces = [
                {
                    x: t,
                    y: x1_true,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'çœŸã®çŠ¶æ…‹ xâ‚',
                    line: { color: '#3498db', width: 2 }
                },
                {
                    x: t,
                    y: x1_obs,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'æ¨å®šçŠ¶æ…‹ xâ‚',
                    line: { color: '#e74c3c', width: 2, dash: 'dash' }
                },
                {
                    x: t,
                    y: x2_true,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'çœŸã®çŠ¶æ…‹ xâ‚‚',
                    line: { color: '#2ecc71', width: 2 }
                },
                {
                    x: t,
                    y: x2_obs,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'æ¨å®šçŠ¶æ…‹ xâ‚‚',
                    line: { color: '#f39c12', width: 2, dash: 'dash' }
                }
            ];
            
            const layout = {
                title: 'çŠ¶æ…‹æ¨å®šã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆç°¡æ˜“ã‚ªãƒ–ã‚¶ãƒ¼ãƒï¼‰',
                xaxis: { title: 'æ™‚é–“ [s]' },
                yaxis: { title: 'çŠ¶æ…‹' },
                hovermode: 'x'
            };
            
            Plotly.newPlot('estimationPlot', traces, layout);
        }

        document.getElementById('systemType').addEventListener('change', function() {
            const type = this.value;
            if (type === 'observable') {
                document.getElementById('a00').value = '-1';
                document.getElementById('a01').value = '1';
                document.getElementById('a10').value = '0';
                document.getElementById('a11').value = '-2';
                document.getElementById('c0').value = '1';
                document.getElementById('c1').value = '0';
            } else if (type === 'unobservable') {
                document.getElementById('a00').value = '-1';
                document.getElementById('a01').value = '1';
                document.getElementById('a10').value = '0';
                document.getElementById('a11').value = '-2';
                document.getElementById('c0').value = '0';
                document.getElementById('c1').value = '1';
            } else if (type === 'partial') {
                document.getElementById('a00').value = '-1';
                document.getElementById('a01').value = '0';
                document.getElementById('a10').value = '0';
                document.getElementById('a11').value = '-2';
                document.getElementById('c0').value = '1';
                document.getElementById('c1').value = '1';
            }
        });
    </script>
</body>
</html>
