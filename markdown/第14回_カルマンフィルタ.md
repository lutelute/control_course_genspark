# 第14回：カルマンフィルタ

## 学習目標
- カルマンフィルタの原理と導出を理解する
- 最適推定理論の基礎を学ぶ
- カルマンフィルタの実装方法を習得する

## 1. はじめに

実際のシステムでは、測定にノイズが含まれ、システム自体にも外乱が作用します。**カルマンフィルタ**は、これらのノイズを考慮した最適な状態推定手法です。1960年代にR.E. Kalmanによって開発されて以来、航空宇宙、ロボティクス、信号処理など、広範な分野で使用されています。

## 2. 確率的システムモデル

### 2.1 システムとノイズ

**状態方程式：**
$$\dot{\mathbf{x}}(t) = \mathbf{A}\mathbf{x}(t) + \mathbf{B}\mathbf{u}(t) + \mathbf{G}\mathbf{w}(t)$$

**出力方程式：**
$$\mathbf{y}(t) = \mathbf{C}\mathbf{x}(t) + \mathbf{v}(t)$$

ここで：
- $\mathbf{w}(t)$：システムノイズ（プロセスノイズ）
- $\mathbf{v}(t)$：測定ノイズ（観測ノイズ）
- $\mathbf{G}$：ノイズ入力行列

### 2.2 ノイズの統計的性質

**仮定：**

$\mathbf{w}(t)$ と $\mathbf{v}(t)$ は、平均ゼロの白色ガウスノイズ：

$$E[\mathbf{w}(t)] = \mathbf{0}, \quad E[\mathbf{v}(t)] = \mathbf{0}$$

**共分散：**
$$E[\mathbf{w}(t)\mathbf{w}^T(\tau)] = \mathbf{W}\delta(t - \tau)$$
$$E[\mathbf{v}(t)\mathbf{v}^T(\tau)] = \mathbf{V}\delta(t - \tau)$$

**独立性：**
$$E[\mathbf{w}(t)\mathbf{v}^T(\tau)] = \mathbf{0}$$

ここで：
- $\mathbf{W}$：システムノイズの共分散行列（正定値）
- $\mathbf{V}$：測定ノイズの共分散行列（正定値）
- $\delta(t)$：ディラックのデルタ関数

## 3. 最適推定問題

### 3.1 目的

出力測定 $\mathbf{y}(t)$ から、状態 $\mathbf{x}(t)$ を推定する。

**推定誤差：**
$$\tilde{\mathbf{x}}(t) = \mathbf{x}(t) - \hat{\mathbf{x}}(t)$$

**最適性の基準：**

推定誤差の共分散行列を最小化：

$$\mathbf{P}(t) = E[\tilde{\mathbf{x}}(t)\tilde{\mathbf{x}}^T(t)]$$

これを**最小分散推定**と呼びます。

### 3.2 フィルタリング vs スムージング

- **フィルタリング**：現在までの測定から現在の状態を推定
- **予測**：現在までの測定から未来の状態を推定
- **スムージング**：すべての測定から過去の状態を推定

本講義では、フィルタリング問題を扱います。

## 4. カルマンフィルタの構造

### 4.1 フィルタ方程式

**状態推定の時間更新（予測）：**
$$\dot{\hat{\mathbf{x}}}(t) = \mathbf{A}\hat{\mathbf{x}}(t) + \mathbf{B}\mathbf{u}(t) + \mathbf{K}(t)[\mathbf{y}(t) - \mathbf{C}\hat{\mathbf{x}}(t)]$$

ここで、$\mathbf{K}(t)$ は**カルマンゲイン**です。

**形式：**
- 第1, 2項：システムモデルによる予測
- 第3項：測定による修正（イノベーション）

### 4.2 カルマンゲインの計算

**カルマンゲイン：**
$$\mathbf{K}(t) = \mathbf{P}(t)\mathbf{C}^T\mathbf{V}^{-1}$$

ここで、$\mathbf{P}(t)$ は推定誤差の共分散行列で、以下の**リッカチ微分方程式**を満たします：

$$\dot{\mathbf{P}}(t) = \mathbf{A}\mathbf{P}(t) + \mathbf{P}(t)\mathbf{A}^T - \mathbf{P}(t)\mathbf{C}^T\mathbf{V}^{-1}\mathbf{C}\mathbf{P}(t) + \mathbf{G}\mathbf{W}\mathbf{G}^T$$

**初期条件：**
$$\mathbf{P}(0) = E[(\mathbf{x}(0) - \hat{\mathbf{x}}(0))(\mathbf{x}(0) - \hat{\mathbf{x}}(0))^T]$$

### 4.3 定常カルマンフィルタ

時間が十分経過すると、$\mathbf{P}(t)$ は定常値に収束します（システムが可制御・可観測の場合）。

**定常リッカチ方程式：**
$$\mathbf{A}\mathbf{P} + \mathbf{P}\mathbf{A}^T - \mathbf{P}\mathbf{C}^T\mathbf{V}^{-1}\mathbf{C}\mathbf{P} + \mathbf{G}\mathbf{W}\mathbf{G}^T = \mathbf{0}$$

定常カルマンゲイン：
$$\mathbf{K}_{\infty} = \mathbf{P}_{\infty}\mathbf{C}^T\mathbf{V}^{-1}$$

## 5. カルマンフィルタの導出

### 5.1 ウィーナー-ホップ方程式

**最適性条件：**

推定誤差 $\tilde{\mathbf{x}}$ が測定 $\mathbf{y}$ と直交：

$$E[\tilde{\mathbf{x}}(t)\mathbf{y}^T(\tau)] = \mathbf{0}, \quad \forall \tau \leq t$$

これは、測定に含まれるすべての情報を使い尽くしたことを意味します。

### 5.2 イノベーション過程

**イノベーション（革新）：**
$$\nu(t) = \mathbf{y}(t) - \mathbf{C}\hat{\mathbf{x}}(t)$$

これは、予測と実測の差であり、新しい情報を表します。

カルマンフィルタは、このイノベーションに基づいて推定を更新します。

### 5.3 共分散行列の時間発展

推定誤差 $\tilde{\mathbf{x}} = \mathbf{x} - \hat{\mathbf{x}}$ のダイナミクス：

$$\dot{\tilde{\mathbf{x}}} = (\mathbf{A} - \mathbf{K}\mathbf{C})\tilde{\mathbf{x}} + \mathbf{G}\mathbf{w} - \mathbf{K}\mathbf{v}$$

共分散行列 $\mathbf{P} = E[\tilde{\mathbf{x}}\tilde{\mathbf{x}}^T]$ の時間微分を計算すると、リッカチ方程式が得られます。

## 6. 離散時間カルマンフィルタ

### 6.1 離散時間システム

$$\mathbf{x}[k+1] = \mathbf{A}_d\mathbf{x}[k] + \mathbf{B}_d\mathbf{u}[k] + \mathbf{w}[k]$$
$$\mathbf{y}[k] = \mathbf{C}_d\mathbf{x}[k] + \mathbf{v}[k]$$

ノイズの統計：
$$E[\mathbf{w}[k]] = \mathbf{0}, \quad E[\mathbf{w}[k]\mathbf{w}^T[j]] = \mathbf{W}_d\delta_{kj}$$
$$E[\mathbf{v}[k]] = \mathbf{0}, \quad E[\mathbf{v}[k]\mathbf{v}^T[j]] = \mathbf{V}_d\delta_{kj}$$

### 6.2 離散時間カルマンフィルタのアルゴリズム

**予測ステップ：**
$$\hat{\mathbf{x}}[k|k-1] = \mathbf{A}_d\hat{\mathbf{x}}[k-1|k-1] + \mathbf{B}_d\mathbf{u}[k-1]$$
$$\mathbf{P}[k|k-1] = \mathbf{A}_d\mathbf{P}[k-1|k-1]\mathbf{A}_d^T + \mathbf{W}_d$$

**更新ステップ：**
$$\mathbf{K}[k] = \mathbf{P}[k|k-1]\mathbf{C}_d^T(\mathbf{C}_d\mathbf{P}[k|k-1]\mathbf{C}_d^T + \mathbf{V}_d)^{-1}$$
$$\hat{\mathbf{x}}[k|k] = \hat{\mathbf{x}}[k|k-1] + \mathbf{K}[k](\mathbf{y}[k] - \mathbf{C}_d\hat{\mathbf{x}}[k|k-1])$$
$$\mathbf{P}[k|k] = (\mathbf{I} - \mathbf{K}[k]\mathbf{C}_d)\mathbf{P}[k|k-1]$$

**記法：**
- $\hat{\mathbf{x}}[k|k-1]$：時刻 $k-1$ までの測定に基づく時刻 $k$ の予測
- $\hat{\mathbf{x}}[k|k]$：時刻 $k$ までの測定に基づく時刻 $k$ の推定

### 6.3 実装のポイント

**数値的安定性：**

共分散更新式には数値誤差が蓄積する可能性があります。

**Joseph形式：**
$$\mathbf{P}[k|k] = (\mathbf{I} - \mathbf{K}[k]\mathbf{C}_d)\mathbf{P}[k|k-1](\mathbf{I} - \mathbf{K}[k]\mathbf{C}_d)^T + \mathbf{K}[k]\mathbf{V}_d\mathbf{K}^T[k]$$

この形式は数値的に安定です。

## 7. カルマンフィルタの性質

### 7.1 最適性

カルマンフィルタは、以下の意味で最適です：

1. **最小分散推定**：推定誤差の共分散を最小化
2. **線形推定の中で最適**：線形推定器のクラスで最良
3. **ガウスノイズの場合、すべての推定器の中で最適**

### 7.2 LQRとの双対性

カルマンフィルタとLQRには深い双対関係があります：

| LQR | カルマンフィルタ |
|-----|--------------|
| 制御入力 $\mathbf{u}$ | カルマンゲイン $\mathbf{K}$ |
| 状態重み $\mathbf{Q}$ | プロセスノイズ $\mathbf{W}$ |
| 入力重み $\mathbf{R}$ | 測定ノイズ $\mathbf{V}$ |
| 閉ループシステム | 推定誤差ダイナミクス |

### 7.3 安定性

システムが可検出（detectable）ならば、カルマンフィルタの推定誤差は減衰します。

## 8. LQG（Linear Quadratic Gaussian）制御

### 8.1 統合

LQR制御とカルマンフィルタを組み合わせた**LQG制御**：

1. カルマンフィルタで状態を推定：$\hat{\mathbf{x}}$
2. LQRゲインで制御：$\mathbf{u} = -\mathbf{K}_{LQR}\hat{\mathbf{x}}$

### 8.2 分離定理

LQGにおいても、制御器とフィルタを独立に設計できます（確率的分離定理）。

**閉ループシステムの極：**
- LQRの極
- カルマンフィルタの極

## 9. 応用例

### 9.1 GPS/INS統合航法

GPS（Global Positioning System）と慣性航法装置（INS）の融合にカルマンフィルタが使用されます。

**状態：** 位置、速度、姿勢

**測定：**
- GPS: 位置（低周波、高精度）
- INS: 加速度、角速度（高周波、ドリフトあり）

### 9.2 ロボットの自己位置推定（SLAM）

同時位置推定と地図作成（SLAM: Simultaneous Localization and Mapping）では、拡張カルマンフィルタ（EKF）が使用されます。

## 10. 演習問題

### 問題1
以下のシステムに対して、定常カルマンゲインを求めよ：
$$\mathbf{A} = \begin{bmatrix} 0 & 1 \\ -1 & -1 \end{bmatrix}, \quad \mathbf{G} = \mathbf{I}, \quad \mathbf{C} = \begin{bmatrix} 1 & 0 \end{bmatrix}$$
$$\mathbf{W} = \mathbf{I}, \quad \mathbf{V} = 1$$

### 問題2
離散時間カルマンフィルタのアルゴリズムを実装し、ノイズを含む測定から状態を推定するシミュレーションを行え。

### 問題3
カルマンフィルタとLQRの双対性を、リッカチ方程式の形式から説明せよ。

## 11. まとめ

- カルマンフィルタは、ノイズ環境下での最適状態推定手法
- 連続時間と離散時間の両方で定式化される
- リッカチ方程式を解いてカルマンゲインを計算
- LQRとの双対性が存在
- GPS、ロボティクス、信号処理など広範な応用
- LQG制御により、推定と制御を統合

## 次回予告

次回は、**サーボシステム**について学びます。目標値追従制御の設計方法を習得します。

## 参考文献

1. Rudolf E. Kalman, "A New Approach to Linear Filtering and Prediction Problems" (1960)
2. Brian D.O. Anderson & John B. Moore, "Optimal Filtering"
3. Dan Simon, "Optimal State Estimation"
